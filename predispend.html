<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกความคลาดเคลื่อนทางยา</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sarabun font for Thai language support and overall aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization in the dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Custom font for the entire body */
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Basic modal styles (hidden by default) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top of other content */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if content is too large */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* Use flexbox for centering content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        /* Styles for the modal content box */
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px; /* Max width for better appearance */
            border-radius: 10px; /* Rounded corners */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        /* Loader animation styles */
        .loader {
            border: 8px solid #f3f3f3; /* Light grey base */
            border-top: 8px solid #3498db; /* Blue spinning part */
            border-radius: 50%; /* Makes it circular */
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite; /* Spin animation */
            margin: 0 auto; /* Center the loader */
        }
        /* Keyframe animation for the spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for dropdowns if they exceed max-height */
        .searchable-dropdown-list {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Application: Now visible by default -->
    <div id="app">
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-md">
            <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="font-bold text-emerald-600">Med Error Report</span>
                        <div class="hidden md:block">
                            <div class="flex items-baseline ml-10 space-x-4">
                                <!-- Navigation links for different pages in specified order -->
                                <button data-page="login-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">ลงชื่อเข้าใช้งาน</button>
                                <button data-page="record-form-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">บันทึกข้อมูล</button>
                                <button data-page="records-list-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">รายการล่าสุด</button>
                                <button data-page="dashboard-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">Dashboard</button>
                                <!-- Dropdown for Settings -->
                                <div class="relative group">
                                    <button class="px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200 flex items-center">
                                        การตั้งค่า
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                        <div class="py-1">
                                            <button data-page="users-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ผู้ใช้งาน</button>
                                            <button data-page="medicines-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">รายการยา</button>
                                            <button data-page="shifts-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">เวร</button>
                                            <button data-page="patient-types-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ประเภทผู้ป่วย</button>
                                            <button data-page="places-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">สถานที่</button>
                                            <button data-page="processes-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">กระบวนการ</button>
                                            <button data-page="causes-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">สาเหตุ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                         <!-- User info display is removed as there's no current user -->
                         <!-- Logout button is also removed -->
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main content area where different pages are rendered -->
        <main class="p-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <!-- Content Pages (each is a placeholder, filled by JavaScript) -->
            <!-- Main pages in order: บันทึกข้อมูล, รายการล่าสุด, Dashboard -->
            <div id="record-form-page" class="page-content hidden"></div>
            <div id="records-list-page" class="page-content hidden"></div>
            <div id="dashboard-page" class="page-content hidden"></div>
            <!-- Settings pages in order: ผู้ใช้งาน, รายการยา, เวร, ประเภทผู้ป่วย, สถานที่, กระบวนการ, สาเหตุ -->
            <div id="users-page" class="page-content hidden"></div>
            <div id="medicines-page" class="page-content hidden"></div>
            <div id="shifts-page" class="page-content hidden"></div>
            <div id="patient-types-page" class="page-content hidden"></div>
            <div id="places-page" class="page-content hidden"></div>
            <div id="processes-page" class="page-content hidden"></div>
            <div id="causes-page" class="page-content hidden"></div>
        </main>
    </div>


    

    <!-- Loading Modal: Displays while data is being fetched or processed -->
    <div id="loading-modal" class="modal">
      <div class="modal-content">
        <div class="loader"></div>
        <p id="loading-text" class="mt-4 text-lg">กำลังบันทึกข้อมูล...</p>
      </div>
    </div>
    
    <!-- Success Modal: Displays upon successful data submission (only after login) -->
    <div id="success-modal" class="modal">
      <div class="modal-content">
        <!-- SVG for a checkmark icon -->
        <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <p class="mt-4 text-lg">บันทึกข้อมูลสำเร็จ!</p>
        <!-- Button to close the success modal -->
        <button onclick="document.getElementById('success-modal').style.display='none'" class="px-4 py-2 mt-4 text-white bg-emerald-500 rounded-md">ตกลง</button>
      </div>
    </div>

    <!-- Login Page: Added for user login functionality -->
    <div id="login-page" class="page-content">
        <div class="p-6 bg-white rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="mb-6 text-xl font-bold text-gray-800">ลงชื่อเข้าใช้งาน</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                    <input type="text" id="username" name="username" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="password" name="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full px-4 py-2 text-white bg-emerald-500 rounded-md hover:bg-emerald-600">เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>

<script>
// Google Apps Script Web App URL for backend operations
// โปรดแทนที่ URL นี้ด้วย URL ของ Web App ที่คุณ Deploy จาก Google Apps Script ของคุณ
// หากต้องการรับ URL นี้:
// 1. ใน Apps Script editor, คลิก "Deploy" (ปรับใช้) > "New deployment" (การทำให้ใช้งานได้ใหม่).
// 2. เลือกประเภทเป็น "Web app" (เว็บแอป).
// 3. ตั้งค่า "Execute as" (เรียกใช้ในฐานะ) เป็น "Me" (ฉัน) และ "Who has access" (ใครมีสิทธิ์เข้าถึง) เป็น "Anyone" (ทุกคน).
// 4. คลิก "Deploy" (ปรับใช้) และคัดลอก "Web app URL" (URL ของเว็บแอป) ที่ปรากฏขึ้นมา
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFrW_xMdCukPq_nx3FsoYHxxq3hH5hSRtvIKfAioJfqet_MKAJjACugUQ-X6ngZ1NqyQ/exec";

// --- Global State Variables ---
// currentUser is no longer needed as login is removed
let masterData = {
    users: [],        // List of all users (still fetched for other purposes like dropdowns if needed)
    medicines: [],    // List of all medicines
    places: [],       // List of places/locations
    processes: [],    // List of processes involved in medication errors
    causes: [],       // List of causes for medication errors
    records: []       // List of all recorded medication errors
};
let currentPage = 1;      // Current page number for pagination
let itemsPerPage = 10;    // Number of items to display per page

// --- DOM Elements Caching ---
// loginPage, loginForm, loginError, userInfo, logoutBtn are removed as login is removed
const appPage = document.getElementById('app');
const navLinks = document.querySelectorAll('.nav-link'); // All navigation buttons
const loadingModal = document.getElementById('loading-modal');
const successModal = document.getElementById('success-modal');
const loginPage = document.getElementById('login-page');
const loginForm = document.getElementById('login-form');

// --- Utility Functions ---

/**
 * Displays the loading modal with a customizable message.
 * @param {string} text - The message to display in the loading modal.
 */
function showLoading(text = 'กำลังโหลดข้อมูล...') {
    document.getElementById('loading-text').textContent = text;
    loadingModal.style.display = 'flex'; // Use flex to center the modal content
}

/**
 * Hides the loading modal.
 */
function hideLoading() {
    loadingModal.style.display = 'none';
}

/**
 * Displays the success modal.
 */
function showSuccess() {
    // Only show success modal if user is logged in
    const currentUser = getCurrentUser();
    if (currentUser) {
        successModal.style.display = 'flex'; // Use flex to center the modal content
    }
}

/**
 * Shows a specific application page and hides all others.
 * Also updates the active state of navigation links.
 * @param {string} pageId - The ID of the page to show.
 */
function showPage(pageId) {
    // Hide all page content divs
    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
    // Show the requested page
    document.getElementById(pageId).classList.remove('hidden');
    
    // Update active navigation link style
    navLinks.forEach(link => {
        if (link.dataset.page === pageId) {
            link.classList.add('bg-gray-200', 'font-bold'); // Add active styles
        } else {
            link.classList.remove('bg-gray-200', 'font-bold'); // Remove active styles
        }
    });    /* Render content specific to the selected page */
    switch (pageId) {
        case 'login-page':
            // Don't render anything special for login page, it's already in HTML
            break;
        case 'records-list-page': renderRecordsList(); break;
        case 'record-form-page': renderRecordForm(); break;
        case 'dashboard-page': renderDashboard(); break;
        case 'users-page': renderUsersPage(); break;
        case 'medicines-page': renderMedicinesPage(); break;
        case 'shifts-page': renderShiftsPage(); break;
        case 'patient-types-page': renderPatientTypesPage(); break;
        case 'places-page': renderPlacesPage(); break;
        case 'processes-page': renderProcessesPage(); break;
        case 'causes-page': renderCausesPage(); break;
    }
}

// --- Data Fetching Functions ---

/**
 * Fetches data from the Google Sheet via the Apps Script API.
 * Displays loading indicators and handles errors.
 * @param {string} action - The action parameter for the Apps Script (e.g., 'getUsers').
 * @returns {Promise<Array>} - A promise that resolves to an array of data.
 */
async function fetchDataFromSheet(action) {
    showLoading(`กำลังโหลดข้อมูล ${action.replace('get', '')} ...`);
    try {
        const response = await fetch(`${SCRIPT_URL}?action=${action}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        // Apps Script usually returns data in a 'data' field, or 'result' as per the provided script
        return data.result || []; 
    } catch (error) {
        console.error(`Error fetching ${action}:`, error);
        // Display a user-friendly alert for network/API errors
        alert(`เกิดข้อผิดพลาดในการดึงข้อมูล ${action.replace('get', 'ข้อมูล')}`);
        return [];
    } finally {
        hideLoading();
    }
}

/**
 * Handles the submission of the record form.
 * Gathers form data, sends it to the Apps Script API, and handles responses.
 * @param {Event} e - The form submission event.
 */
async function handleRecordSubmit(e) {
    e.preventDefault(); // Prevent default form submission

    const form = e.target;
    const formData = new FormData(form);
    const recordData = {};

    // Collect data from form fields
    for (let [key, value] of formData.entries()) {
        recordData[key] = value;
    }

    // Handle "other" process input if selected
    const processSelect = document.getElementById('process');
    const processOtherInput = document.getElementById('process_other');
    if (processSelect.value === 'อื่นๆ') {
        recordData['กระบวนการ'] = processOtherInput.value;
    } else {
        recordData['กระบวนการ'] = processSelect.value;
    }

    // --- เพิ่มการคำนวณค่า HAD ---
    const correctMedName = document.getElementById('correct_medicine_search').value;
    const incorrectMedName = document.getElementById('incorrect_medicine_search').value;
    const correctMed = masterData.medicines.find(m => m.Name === correctMedName);
    const incorrectMed = masterData.medicines.find(m => m.Name === incorrectMedName);
    const isHad = (correctMed && correctMed.HAD && String(correctMed.HAD).toLowerCase() === 'yes') ||
                  (incorrectMed && incorrectMed.HAD && String(incorrectMed.HAD).toLowerCase() === 'yes');
    recordData['HAD'] = isHad ? 'HAD' : '';
    // --- จบการเพิ่ม HAD ---

    // Handle "other" cause input if selected
    const causeSelect = document.getElementById('cause');
    const causeOtherInput = document.getElementById('cause_other');
    if (causeSelect.value === 'อื่นๆ') {
        recordData['cause'] = causeOtherInput.value;
    } else {
        recordData['cause'] = causeSelect.value;
    }

    // Prepare data to send as query parameters
    const dataToSend = {
        action: 'addrecord', // Action for Apps Script
        'วันที่เกิดเหตุการณ์': recordData['event_date'],
        'เวร': recordData['shift'],
        'ประเภทผู้ป่วย': recordData['patient_type'],
        'สถานที่': recordData['place'],
        'กระบวนการ': recordData['กระบวนการ'], // Use the processed value
        'รายการยาที่ถูกต้อง': recordData['correct_medicine_search'],
        'รายการยาที่ผิด': recordData['incorrect_medicine_search'],
        'HAD': recordData['HAD'], // --- ส่งค่า HAD ---
        'สาเหตุ': recordData['cause'],
        'รายละเอียดเพิ่มเติม': recordData['details'],
        'ผู้รายงาน': getCurrentUser() ? getCurrentUser().ชื่อ : 'ไม่ระบุ' // ใช้ชื่อผู้ใช้ที่ล็อกอิน
    };

    // Convert dataToSend object into URL query parameters
    const queryParams = new URLSearchParams(dataToSend).toString();
    
    showLoading('กำลังบันทึกข้อมูล...');
    try {
        // Use GET method and append query parameters to the SCRIPT_URL
        const response = await fetch(`${SCRIPT_URL}?${queryParams}`);

        const result = await response.json();

        if (result.status === 'success') {
            // Only show success modal if user is logged in
            const currentUser = getCurrentUser();
            if (currentUser) {
                showSuccess(); // Show success modal
            }
            form.reset(); // Clear the form
            document.getElementById('event_date').valueAsDate = new Date(); // Reset date to today
            // Reload records data after successful submission
            masterData.records = await fetchDataFromSheet('getRecords');
            masterData.records.sort((a,b) => new Date(b.วันที่เกิดเหตุการณ์) - new Date(a.วันที่เกิดเหตุการณ์));
            // Ensure HAD status resets or is re-evaluated if needed
            document.getElementById('had_status').textContent = 'กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD';
            document.getElementById('had_status').parentElement.className = 'p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2';
        } else {
            alert(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${result.message}`); // Show error message
        }
    } catch (error) {
        console.error('Error submitting record:', error);
        alert(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`);
    } finally {
        hideLoading();
    }
}


// --- Main Application Data Loading ---

/**
 * Loads all essential master data (medicines, places, processes, causes, records)
 * from the Google Sheet. This is called once the application initializes.
 */
async function loadAllMasterData() {
    showLoading('กำลังโหลดข้อมูลหลัก...');
    const dataActions = ['getUsers', 'getMedicines', 'getPlaces', 'getProcesses', 'getCauses', 'getRecords'];
    
    // Fetch all data concurrently using Promise.all
    const [users, medicines, places, processes, causes, records] = await Promise.all(
        dataActions.map(action => fetchDataFromSheet(action))
    );
    
    // Update global masterData object
    masterData.users = users; // Users data is still fetched in case other parts of the app need it
    masterData.medicines = medicines;
    masterData.places = places;
    masterData.processes = processes;
    masterData.causes = causes;
    // Sort records by date in descending order (most recent first)
    masterData.records = records.sort((a,b) => new Date(b.วันที่เกิดเหตุการณ์) - new Date(a.วันที่เกิดเหตุการณ์));
    
    hideLoading();
}

// Attach event listeners to all navigation links to switch pages
navLinks.forEach(link => {
    link.addEventListener('click', (e) => showPage(e.target.dataset.page));
});

// --- Page Rendering Functions ---

/**
 * Renders the list of medication error records, including search and pagination.
 * @param {string} searchTerm - Optional search term to filter records.
 */
function renderRecordsList(searchTerm = '') {
    const container = document.getElementById('records-list-page');
    
    // Filter records based on the search term
    const filteredRecords = masterData.records.filter(r => 
        (r.เลขที่รายงาน && r.เลขที่รายงาน.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (r.สถานที่ && r.สถานที่.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (r.รายการยาที่ผิด && r.รายการยาที่ผิด.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (r.กระบวนการ && r.กระบวนการ.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (r.รายละเอียดเพิ่มเติม && r.รายละเอียดเพิ่มเติม.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    // Calculate pagination parameters
    const totalPages = Math.ceil(filteredRecords.length / itemsPerPage);
    const paginatedRecords = filteredRecords.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <div class="flex flex-col items-center justify-between gap-4 mb-4 md:flex-row">
                <h2 class="text-xl font-bold text-gray-800">รายการที่บันทึก</h2>
                <div class="flex items-center gap-4">
                     <input type="text" id="search-record" placeholder="ค้นหารายการ..." class="px-3 py-2 border border-gray-300 rounded-md" value="${searchTerm}">
                     <button id="export-csv" class="px-4 py-2 text-white bg-teal-600 rounded-md hover:bg-teal-700">ส่งออก (CSV)</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">เลขที่รายงาน</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">วันที่บันทึก</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">วันที่เกิดเหตุการณ์</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">สถานที่</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">รายการยาที่ผิด</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">กระบวนการ</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">รายละเอียดเพิ่มเติม</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ผู้รายงาน</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="divide-y divide-gray-200">
                        ${paginatedRecords.length > 0 ? paginatedRecords.map(r => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${r.เลขที่รายงาน || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.วันที่บันทึก ? new Date(r.วันที่บันทึก).toLocaleDateString('th-TH') : ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.วันที่เกิดเหตุการณ์ ? new Date(r.วันที่เกิดเหตุการณ์).toLocaleDateString('th-TH') : ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.สถานที่ || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.รายการยาที่ผิด || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.กระบวนการ || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.รายละเอียดเพิ่มเติม || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${r.ผู้รายงาน || ''}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">ไม่พบข้อมูล</td></tr>`}
                    </tbody>
                </table>
            </div>
             <div class="flex items-center justify-between mt-4">
                <div class="flex items-center gap-2">
                    <label for="items-per-page" class="text-sm text-gray-700">แสดง:</label>
                    <select id="items-per-page" class="p-1 border border-gray-300 rounded-md text-sm">
                        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                        <option value="30" ${itemsPerPage === 30 ? 'selected' : ''}>30</option>
                        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                    </select>
                    <span class="text-sm text-gray-700">รายการ</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prev-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''}>ก่อนหน้า</button>
                    <span class="text-sm text-gray-700">หน้า ${totalPages === 0 ? 0 : currentPage} จาก ${totalPages}</span>
                    <button id="next-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>ถัดไป</button>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners for search, export, and pagination controls
    document.getElementById('search-record').addEventListener('input', (e) => {
        currentPage = 1; // Reset to first page on new search
        renderRecordsList(e.target.value);
    });
    document.getElementById('export-csv').addEventListener('click', () => exportToCSV(filteredRecords));
    document.getElementById('items-per-page').addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1; // Reset to first page when items per page changes
        renderRecordsList(document.getElementById('search-record').value);
    });
    document.getElementById('prev-page')?.addEventListener('click', () => {
        if(currentPage > 1) {
            currentPage--;
            renderRecordsList(document.getElementById('search-record').value);
        }
    });
    document.getElementById('next-page')?.addEventListener('click', () => {
        if(currentPage < totalPages) {
            currentPage++;
            renderRecordsList(document.getElementById('search-record').value);
        }
    });
}

/**
 * Exports the given data to a CSV file.
 * @param {Array<Object>} data - The array of objects to export.
 */
function exportToCSV(data) {
    if (data.length === 0) {
        alert("ไม่มีข้อมูลสำหรับส่งออก.");
        return;
    }

    const headers = Object.keys(data[0]);
    // Convert array of objects to CSV string
    const csv = [
        headers.join(','), // Header row
        ...data.map(row => headers.map(fieldName => {
            let value = row[fieldName] === null || row[fieldName] === undefined ? '' : row[fieldName];
            // Handle dates specifically for CSV
            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)) {
                const date = new Date(value);
                value = isNaN(date.getTime()) ? '' : date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH');
            }
            // Escape values containing commas or double quotes
            return `"${String(value).replace(/"/g, '""')}"`;
        }).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `medical_records_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    URL.revokeObjectURL(link.href); // Clean up
}


/**
 * Renders the form for submitting a new medication error record.
 * Populates dropdowns with master data and handles HAD status checking.
 */
function renderRecordForm() {
    const container = document.getElementById('record-form-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">บันทึกรายการความคลาดเคลื่อนทางยา</h2>
            <form id="record-form" class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div class="md:col-span-2">
                    <label for="event_date" class="block text-sm font-medium text-gray-700">วันที่เกิดเหตุการณ์</label>
                    <input type="date" id="event_date" name="event_date" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="shift" class="block text-sm font-medium text-gray-700">เวร</label>
                    <select id="shift" name="shift" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        <option value="เช้า">เช้า</option>
                        <option value="บ่าย">บ่าย</option>
                        <option value="ดึก">ดึก</option>
                    </select>
                </div>
                <div>
                    <label for="patient_type" class="block text-sm font-medium text-gray-700">ประเภทผู้ป่วย</label>
                    <select id="patient_type" name="patient_type" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        <option value="นอก">นอก (OPD)</option>
                        <option value="ใน">ใน (IPD)</option>
                    </select>
                </div>
                <div>
                    <label for="place" class="block text-sm font-medium text-gray-700">สถานที่</label>
                    <select id="place" name="place" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        ${masterData.places.map(p => `<option value="${p.Name}">${p.Name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="process" class="block text-sm font-medium text-gray-700">กระบวนการ</label>
                    <select id="process" name="process" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        ${masterData.processes.map(p => `<option value="${p.Name}">${p.Name}</option>`).join('')}
                        <option value="อื่นๆ">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" id="process_other" name="process_other" class="hidden w-full px-3 py-2 mt-2 border border-gray-300 rounded-md" placeholder="ระบุกระบวนการอื่นๆ">
                </div>
                 <div>
                    <label for="correct_medicine_search" class="block text-sm font-medium text-gray-700">รายการยาที่ถูกต้อง</label>
                    <!-- Input with datalist for searchable dropdown functionality -->
                    <input type="text" id="correct_medicine_search" name="correct_medicine_search" list="medicine-list" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="ค้นหายา...">
                </div>
                 <div>
                    <label for="incorrect_medicine_search" class="block text-sm font-medium text-gray-700">รายการยาที่ผิด</label>
                    <!-- Input with datalist for searchable dropdown functionality -->
                    <input type="text" id="incorrect_medicine_search" name="incorrect_medicine_search" list="medicine-list" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="ค้นหายา...">
                </div>
                <!-- Datalist provides suggestions for medicine inputs -->
                <datalist id="medicine-list">
                    ${masterData.medicines.map(m => `<option value="${m.Name}">`).join('')}
                </datalist>

                <!-- High Alert Drug (HAD) status display -->
                <div class="p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2">
                    <p class="font-bold text-teal-800">High Alert Drug (HAD)</p>
                    <p id="had_status" class="text-teal-700">กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD</p>
                </div>
                
                <div class="md:col-span-2">
                    <label for="cause" class="block text-sm font-medium text-gray-700">สาเหตุ</label>
                    <select id="cause" name="cause" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                       ${masterData.causes.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('')}
                       <option value="อื่นๆ">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" id="cause_other" name="cause_other" class="hidden w-full px-3 py-2 mt-2 border border-gray-300 rounded-md" placeholder="ระบุสาเหตุอื่นๆ">
                </div>

                <div class="md:col-span-2">
                    <label for="details" class="block text-sm font-medium text-gray-700">รายละเอียดเพิ่มเติม</label>
                    <textarea id="details" name="details" rows="4" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></textarea>
                </div>

                <div class="md:col-span-2 flex justify-end gap-2 mt-4">
                    <button type="button" id="reset-form-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">ล้างข้อมูล</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    `;

    // Set default date for new record form to today
    document.getElementById('event_date').valueAsDate = new Date();

    // Logic to show/hide "other" input for process field
    const processSelect = document.getElementById('process');
    const processOtherInput = document.getElementById('process_other');
    processSelect.addEventListener('change', () => {
        processOtherInput.classList.toggle('hidden', processSelect.value !== 'อื่นๆ');
        // Clear value if hidden
        if (processOtherInput.classList.contains('hidden')) {
            processOtherInput.value = '';
        }
    });

    // Logic to show/hide "other" input for cause field
    const causeSelect = document.getElementById('cause');
    const causeOtherInput = document.getElementById('cause_other');
    causeSelect.addEventListener('change', () => {
        causeOtherInput.classList.toggle('hidden', causeSelect.value !== 'อื่นๆ');
        if (causeOtherInput.classList.contains('hidden')) {
            causeOtherInput.value = '';
        }
    });

    // Logic for High Alert Drug (HAD) status check
    const correctMedInput = document.getElementById('correct_medicine_search');
    const incorrectMedInput = document.getElementById('incorrect_medicine_search');
    const hadStatus = document.getElementById('had_status');

    /**
     * Checks if either the correct or incorrect medicine selected is a High Alert Drug
     * and updates the HAD status display accordingly.
     */
    function checkHAD() {
        const correctMedName = correctMedInput.value;
        const incorrectMedName = incorrectMedInput.value;
        
        // Find medicine objects from master data
        const correctMed = masterData.medicines.find(m => m.Name === correctMedName);
        const incorrectMed = masterData.medicines.find(m => m.Name === incorrectMedName);

        // Determine HAD status based on 'HAD' property of the medicines
        // Normalize the HAD property to lowercase for consistent comparison
        const isHad = (correctMed && correctMed.HAD && String(correctMed.HAD).toLowerCase() === 'yes') || 
                      (incorrectMed && incorrectMed.HAD && String(incorrectMed.HAD).toLowerCase() === 'yes');
        
        // Update text and background/border color based on HAD status
        hadStatus.textContent = isHad ? 'ใช่ - รายการยานี้เป็น High Alert Drug' : 'ไม่ใช่';
        hadStatus.parentElement.className = isHad 
            ? 'p-3 bg-lime-100 border-l-4 border-lime-500 rounded-md md:col-span-2' // Lime for HAD
            : 'p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2'; // Teal for non-HAD
    }

    // Attach event listeners to medicine input fields for HAD check
    correctMedInput.addEventListener('input', checkHAD); // Use 'input' for real-time check as user types/selects
    incorrectMedInput.addEventListener('input', checkHAD); // Use 'input' for real-time check

    // Attach event listener for form submission
    document.getElementById('record-form').addEventListener('submit', handleRecordSubmit);

    // Attach event listener for reset button (ล้างข้อมูล)
    document.getElementById('reset-form-btn').addEventListener('click', () => {
        const form = document.getElementById('record-form');
        if (form) {
            form.reset();
            // รีเซ็ตวันที่ให้เป็นวันนี้ (ถ้ามี input date)
            const dateInput = document.getElementById('event_date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
            // รีเซ็ต select ให้เลือก option แรก ("เลือก...")
            ['shift','patient_type','place','process','cause'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.selectedIndex = 0;
            });
            // รีเซ็ตสถานะ HAD (ถ้ามี)
            const hadStatus = document.getElementById('had_status');
            if (hadStatus) {
                hadStatus.textContent = 'กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD';
                hadStatus.parentElement.className = 'p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2';
            }
            // ซ่อนช่อง process_other/cause_other (ถ้ามี)
            const processOtherInput = document.getElementById('process_other');
            if (processOtherInput) {
                processOtherInput.classList.add('hidden');
                processOtherInput.value = '';
            }
            const causeOtherInput = document.getElementById('cause_other');
            if (causeOtherInput) {
                causeOtherInput.classList.add('hidden');
                causeOtherInput.value = '';
            }
            // --- Enable ปุ่มล้างข้อมูลเสมอ ---
            const resetBtn = document.getElementById('reset-form-btn');
            if (resetBtn) {
                resetBtn.disabled = false;
            }
        }
    });
}

/**
 * Renders the dashboard with charts summarizing medication error data.
 */
function renderDashboard() {
    const container = document.getElementById('dashboard-page');
    // Display message if no records are available for the dashboard
    if (!masterData.records || masterData.records.length === 0) {
        container.innerHTML = `<div class="p-6 bg-white rounded-lg shadow-md"><p class="text-center text-gray-500">ไม่มีข้อมูลสำหรับแสดงผล Dashboard</p></div>`;
        return;
    }

    // --- Data Aggregation for Charts ---
    const totalReports = masterData.records.length;
    
    // นับจำนวนรายงานที่มีค่า HAD ใน record โดยตรง (คอลัมน์ HAD ไม่ว่างและไม่ใช่ null)
    const hadReports = masterData.records.filter(rec => (rec.HAD || '').toString().trim().toUpperCase() === 'HAD').length;

    // รวบรวมข้อมูลตามปี
    const byYear = masterData.records.reduce((acc, rec) => {
        const eventDate = new Date(rec.วันที่เกิดเหตุการณ์);
        if (!isNaN(eventDate)) {
            const year = eventDate.getFullYear();
            acc[year] = (acc[year] || 0) + 1;
        }
        return acc;
    }, {});
    
    // Aggregate records by Month and Year (using event date)
    const byMonthYear = masterData.records.reduce((acc, rec) => {
        const eventDate = new Date(rec.วันที่เกิดเหตุการณ์);
        if (!isNaN(eventDate)) {
            // Format as "Month Year" (e.g., "ตุลาคม 2566")
            const monthYear = eventDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
            const year = eventDate.getFullYear().toString();
            
            if (!acc[year]) {
                acc[year] = {};
            }
            
            acc[year][monthYear] = (acc[year][monthYear] || 0) + 1;
        }
        return acc;
    }, {});

    // Aggregate records by Shift
    const byShift = masterData.records.reduce((acc, rec) => {
        const shift = rec.เวร || 'ไม่ระบุ';
        acc[shift] = (acc[shift] || 0) + 1;
        return acc;
    }, {});
    
    // Aggregate records by Place
    const byPlace = masterData.records.reduce((acc, rec) => {
        const place = rec.สถานที่ || 'ไม่ระบุ';
        acc[place] = (acc[place] || 0) + 1;
        return acc;
    }, {});

    // Aggregate records by Patient Type
    const byPatientType = masterData.records.reduce((acc, rec) => {
        const patientType = rec.ประเภทผู้ป่วย || 'ไม่ระบุ';
        acc[patientType] = (acc[patientType] || 0) + 1;
        return acc;
    }, {});
    
    // Aggregate records by Process
    const byProcess = masterData.records.reduce((acc, rec) => {
        const process = rec.กระบวนการ || 'ไม่ระบุ';
        acc[process] = (acc[process] || 0) + 1;
        return acc;
    }, {});
    
    // นับความถี่ของยาที่ผิด
    const incorrectMedicineFrequency = masterData.records.reduce((acc, rec) => {
        const medicine = rec.รายการยาที่ผิด || 'ไม่ระบุ';
        acc[medicine] = (acc[medicine] || 0) + 1;
        return acc;
    }, {});
    
    // เรียงลำดับยาที่ผิดบ่อยที่สุด 10 อันดับแรก
    const topInvalidMedicines = Object.entries(incorrectMedicineFrequency)
        .filter(([medicine]) => medicine !== 'ไม่ระบุ')
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    // --- HTML Structure for Dashboard ---
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">Dashboard สรุปรายงาน</h2>
            
            <!-- ส่วนของตัวเลือกในการแสดงข้อมูล -->
            <div class="mb-6 flex flex-wrap items-center gap-4">
                <div>
                    <label for="display-year-select" class="block text-sm font-medium text-gray-700 mb-1">เลือกปีที่แสดง</label>
                    <select id="display-year-select" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="all">ทุกปี</option>
                        ${Object.keys(byYear).sort((a, b) => b - a).map(year => 
                            `<option value="${year}">${year}</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label for="display-view-type" class="block text-sm font-medium text-gray-700 mb-1">แสดงข้อมูลแบบ</label>
                    <select id="display-view-type" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="monthly">รายเดือน</option>
                        <option value="yearly">รายปี</option>
                    </select>
                </div>
            </div>
            
            <!-- สรุปจำนวน -->
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                <div class="p-4 text-white bg-emerald-500 rounded-lg shadow">
                    <div class="text-sm font-medium uppercase">รายงานทั้งหมด</div>
                    <div class="mt-1 text-3xl font-bold">${totalReports}</div>
                </div>
                <div class="p-4 text-white bg-red-500 rounded-lg shadow">
                    <div class="text-sm font-medium uppercase">รายงาน HAD</div>
                    <div class="mt-1 text-3xl font-bold">${hadReports}</div>
                </div>
            </div>
            
            <!-- แผนภูมิแสดงข้อมูลตามช่วงเวลา -->
            <div class="p-4 bg-gray-100 rounded-lg shadow-sm mb-6" style="height:400px;max-height:400px;">
                <h3 class="mb-4 text-lg font-bold text-gray-700">รายงานตามช่วงเวลา</h3>
                <canvas id="timeChart" style="height:100%;max-height:400px;width:100%;"></canvas>
            </div>
            
            <!-- แผนภูมิแสดงข้อมูลตามเวรและประเภทผู้ป่วย -->
            <div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-2">
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm" style="height:400px;max-height:400px;">
                    <h3 class="mb-2 text-lg font-bold text-gray-700">รายงานตามเวร</h3>
                    <canvas id="shiftChart" style="height:100%;max-height:400px;width:100%;"></canvas>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm" style="height:400px;max-height:400px;">
                    <h3 class="mb-2 text-lg font-bold text-gray-700">รายงานตามประเภทผู้ป่วย</h3>
                    <canvas id="patientTypeChart" style="height:100%;max-height:400px;width:100%;"></canvas>
                </div>
            </div>
            
            <!-- แผนภูมิแสดงข้อมูลตามสถานที่และกระบวนการ -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm" style="height:400px;max-height:400px;">
                    <h3 class="mb-2 text-lg font-bold text-gray-700">รายงานตามสถานที่</h3>
                    <canvas id="placeChart" style="height:100%;max-height:400px;width:100%;"></canvas>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg shadow-sm" style="height:400px;max-height:400px;">
                    <h3 class="mb-2 text-lg font-bold text-gray-700">รายงานตามกระบวนการ</h3>
                    <canvas id="processChart" style="height:100%;max-height:400px;width:100%;"></canvas>
                </div>
            </div>
            
            <!-- สถิติยาที่จัดผิด 10 อันดับ -->
            <div class="p-4 bg-gray-100 rounded-lg shadow-sm">
                <h3 class="mb-4 text-lg font-bold text-gray-700">10 อันดับยาที่จัดผิดบ่อย</h3>
                <div style="height:400px;max-height:400px;">
                  <canvas id="topMedicinesChart" style="height:100%;max-height:400px;width:100%;"></canvas>
                </div>
                <div class="overflow-x-auto mt-6">
                    <table class="min-w-full bg-white divide-y divide-gray-200 rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ลำดับ</th>
                                <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อยา</th>
                                <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">จำนวน</th>
                            </tr>
                        </thead>
                        <tbody id="top-medicine-table-body" class="divide-y divide-gray-200">
                            <!-- ตารางนี้จะถูกเติมข้อมูลด้วย JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // เก็บข้อมูลเพื่อใช้ในการอัปเดต chart เมื่อมีการเปลี่ยนแปลงตัวเลือก
    window.dashboardData = {
        byMonthYear,
        byYear,
        byShift,
        byPlace,
        byPatientType,
        byProcess,
        topInvalidMedicines
    };    // --- Chart.js Initialization ---
    
    // Function to create a Chart.js chart - compatible with Chart.js 3.x
    const createChart = (elementId, type, labels, data, labelText, backgroundColor, showLegend = false) => {
        const element = document.getElementById(elementId);
        if (!element) {
            console.warn(`Element with ID ${elementId} not found`);
            return null;
        }
        
        const ctx = element.getContext('2d');
        if (ctx) {
            try {
                // Ensure proper border color formatting for Chart.js 3.x
                let borderColors = backgroundColor;
                if (type === 'line') {
                    borderColors = 'rgba(75, 192, 192, 1)';
                } else if (Array.isArray(backgroundColor)) {
                    borderColors = backgroundColor.map(color => {
                        if (typeof color === 'string') {
                            return color.replace(/rgba\((\d+,\s*\d+,\s*\d+),\s*[\d.]+\)/, 'rgba($1, 1)');
                        }
                        return color;
                    });
                }
                
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: labelText,
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: showLegend,
                                position: 'right'
                            },
                            title: {
                                display: true,
                                text: labelText,
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating chart ${elementId}:`, error);
                return null;
            }
        }
        return null;
    };

    // Define consistent color palette
    const chartColors = [
        'rgba(75, 192, 192, 0.6)', // Teal
        'rgba(153, 102, 255, 0.6)', // Purple
        'rgba(255, 159, 64, 0.6)', // Orange
        'rgba(255, 99, 132, 0.6)', // Red
        'rgba(54, 162, 235, 0.6)', // Blue
        'rgba(201, 203, 207, 0.6)', // Grey
        'rgba(255, 205, 86, 0.6)', // Yellow
        'rgba(22, 160, 133, 0.6)', // Green
        'rgba(142, 68, 173, 0.6)', // Dark Purple
        'rgba(243, 156, 18, 0.6)', // Yellow
        'rgba(231, 76, 60, 0.6)', // Red
        'rgba(52, 152, 219, 0.6)'  // Blue
    ];
    
    // รายงานตามช่วงเวลา - เริ่มต้นแสดงรายเดือน
    const currentYear = new Date().getFullYear().toString();
    let selectedYear = 'all'; // แสดงทุกปี
    let viewType = 'monthly'; // แสดงรายเดือน    // เก็บ chart instances ไว้อ้างอิงเพื่อทำลายเมื่อสร้างใหม่
    let timeChartInstance = null;

    function updateTimeChart() {
        const timeChartElement = document.getElementById('timeChart');
        if (!timeChartElement) {
            console.warn('timeChart element not found');
            return;
        }

        try {
            // ถ้ามีกราฟอยู่แล้วให้ทำลายก่อน
            if (timeChartInstance) {
                timeChartInstance.destroy();
            }
        } catch (error) {
            console.error('Error destroying previous chart:', error);
            // ถ้าไม่สามารถทำลายได้ ให้สร้าง canvas ใหม่แทน
            const parent = timeChartElement.parentNode;
            parent.removeChild(timeChartElement);
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'timeChart';
            parent.appendChild(newCanvas);
        }
        
        let labels, data;
        
        if (viewType === 'yearly') {
            // แสดงข้อมูลเป็นรายปี
            labels = Object.keys(window.dashboardData.byYear).sort();
            data = labels.map(year => window.dashboardData.byYear[year]);
              timeChartInstance = createChart('timeChart', 'bar', labels, data, 'จำนวนรายงานตามปี', chartColors);
        } else {
            // แสดงข้อมูลเป็นรายเดือน
            let monthYearData;
            
            if (selectedYear === 'all') {
                // รวมข้อมูลทุกปี
                monthYearData = Object.values(window.dashboardData.byMonthYear)
                    .reduce((acc, yearData) => {
                        Object.entries(yearData).forEach(([month, count]) => {
                            acc[month] = (acc[month] || 0) + count;
                        });
                        return acc;
                    }, {});
            } else {
                // แสดงข้อมูลเฉพาะปีที่เลือก
                monthYearData = window.dashboardData.byMonthYear[selectedYear] || {};
            }
            
            // เรียงเดือนตามลำดับเวลา
            const sortedMonthsYears = Object.keys(monthYearData).sort((a, b) => {
                const dateA = new Date(a.replace(' ', ' 1, '));
                const dateB = new Date(b.replace(' ', ' 1, '));
                return dateA - dateB;
            });
            
            labels = sortedMonthsYears;
            data = labels.map(month => monthYearData[month]);
            
            timeChartInstance = createChart('timeChart', 'line', labels, data, 'จำนวนรายงานตามเดือน', chartColors);
        }
    }
      // สร้างกราฟแสดงข้อมูลตามเวรและประเภทผู้ป่วย
    if (document.getElementById('shiftChart')) {
        createChart('shiftChart', 'pie', Object.keys(byShift), Object.values(byShift), 'จำนวนรายงานตามเวร', chartColors.slice(0, Object.keys(byShift).length), true);
    }
    
    if (document.getElementById('patientTypeChart')) {
        createChart('patientTypeChart', 'pie', Object.keys(byPatientType), Object.values(byPatientType), 'จำนวนรายงานตามประเภทผู้ป่วย', chartColors.slice(0, Object.keys(byPatientType).length), true);
    }

    // สร้างกราฟแสดงข้อมูลตามสถานที่และกระบวนการ
    if (document.getElementById('placeChart')) {
        createChart('placeChart', 'bar', Object.keys(byPlace), Object.values(byPlace), 'จำนวนรายงานตามสถานที่', chartColors.slice(0, Object.keys(byPlace).length));
    }
    
    if (document.getElementById('processChart')) {
        createChart('processChart', 'bar', Object.keys(byProcess), Object.values(byProcess), 'จำนวนรายงานตามกระบวนการ', chartColors.slice(0, Object.keys(byProcess).length));
    }    // สร้างกราฟแสดงยาที่จัดผิดบ่อย 10 อันดับแรก
    if (topInvalidMedicines.length > 0) {
        const medicineLabels = topInvalidMedicines.map(item => item[0]);
        const medicineCounts = topInvalidMedicines.map(item => item[1]);
        
        const topMedicinesElement = document.getElementById('topMedicinesChart');
        if (topMedicinesElement) {
            try {
                const ctx = topMedicinesElement.getContext('2d');
                if (ctx) {
                    // เตรียมสีสำหรับกราฟ
                    const colors = chartColors.slice(0, topInvalidMedicines.length);
                    const borderColors = colors.map(color => {
                        if (typeof color === 'string') {
                            return color.replace(/rgba\((\d+,\s*\d+,\s*\d+),\s*[\d.]+\)/, 'rgba($1, 1)');
                        }
                        return color;
                    });
                      new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: medicineLabels,
                            datasets: [{
                                label: '10 อันดับยาที่จัดผิดบ่อย',
                                data: medicineCounts,
                                backgroundColor: colors,
                                borderColor: borderColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y', // แสดงแนวนอน
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '10 อันดับยาที่จัดผิดบ่อย',
                                    font: {
                                        size: 16
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Error creating top medicines chart:', err);
            }
        } else {
            console.log('Element topMedicinesChart not found');
        }
    } else {
        console.log('No invalid medicines data available');
    }
    
    // เติมข้อมูลตาราง 10 อันดับยาที่จัดผิดบ่อย
    const tableBody = document.getElementById('top-medicine-table-body');
    if (tableBody) {
        tableBody.innerHTML = topInvalidMedicines.map((item, idx) => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-center">${idx + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap">${item[0]}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">${item[1]}</td>
            </tr>
        `).join('');
    }
    
    // เพิ่ม event listeners สำหรับตัวเลือกแสดงข้อมูล
    document.getElementById('display-year-select')?.addEventListener('change', function() {
        selectedYear = this.value;
        updateTimeChart();
    });
    
    document.getElementById('display-view-type')?.addEventListener('change', function() {
        viewType = this.value;
        updateTimeChart();
    });
    
    // เริ่มต้นด้วยการแสดงกราฟตามเวลา
    updateTimeChart();
}

// Placeholder for User Management Page (if needed in future)
function renderUsersPage() {
    const container = document.getElementById('users-page');
    // NOTE: This page will be accessible by anyone since login is removed.
    // Consider adding a simple form for direct user input for "ผู้รายงาน" if needed.
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการผู้ใช้</h2>
            <p class="text-gray-600">หน้านี้สำหรับดูข้อมูลผู้ใช้งานเท่านั้น เนื่องจากระบบล็อกอินถูกนำออกไปแล้ว.</p>
            <!-- Content for user management, e.g., table of users -->
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ID13</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อ</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ระดับ</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="divide-y divide-gray-200">
                        ${masterData.users.length > 0 ? masterData.users.map(user => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${user.ID13 || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.Name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.Level || ''}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลผู้ใช้งาน</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Placeholder for Medicine Management Page (if needed in future)
function renderMedicinesPage() {
    const container = document.getElementById('medicines-page');
    // NOTE: This page will be accessible by anyone since login is removed.
    // Consider adding a simple form for direct user input for "ผู้รายงาน" if needed.
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการยา</h2>
            <p class="text-gray-600">หน้านี้สำหรับดูข้อมูลยาเท่านั้น เนื่องจากระบบล็อกอินถูกนำออกไปแล้ว.</p>
            <!-- Content for medicine management, e.g., table of medicines -->
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อยา</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">HAD</th>
                        </tr>
                    </thead>
                    <tbody id="medicines-table-body" class="divide-y divide-gray-200">
                        ${masterData.medicines.length > 0 ? masterData.medicines.map(med => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${med.Name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${med.HAD || ''}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลยา</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

/**
 * Updates the navigation bar to show user information and logout button
 * @param {Object} user - The logged-in user object
 */
function updateNavigationForLoggedInUser(user) {
    const userInfoContainer = document.querySelector('nav .flex.items-center:last-child');
    if (userInfoContainer) {
        userInfoContainer.innerHTML = `
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-700">สวัสดี, ${user.ชื่อ || user.Name}</span>
                <button id="logout-btn" class="px-3 py-1 text-sm text-white bg-red-500 rounded-md hover:bg-red-600">ออกจากระบบ</button>
            </div>
        `;
        
        // Add logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const result = await Swal.fire({
                title: 'ต้องการออกจากระบบ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ออกจากระบบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                sessionStorage.removeItem('currentUser');
                await Swal.fire({
                    title: 'ออกจากระบบสำเร็จ',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                
                // Redirect to login page
                appPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                
                // Clear login form
                document.getElementById('login-form').reset();
            }
        });
    }
}

/**
 * Get current logged-in user information from sessionStorage
 * @returns {Object|null} Current user object or null if not logged in
 */
function getCurrentUser() {
    const userStr = sessionStorage.getItem('currentUser');
    return userStr ? JSON.parse(userStr) : null;
}

// Initialize the application when the page loads
document.addEventListener('DOMContentLoaded', async () => {
    // ✅ แสดง SweetAlert เมื่อหน้าเว็บโหลดครั้งแรก
    Swal.fire({
        title: "ยินดีต้อนรับ",
        text: "กรุณาเข้าสู่ระบบก่อนใช้งาน",
        icon: "info",
        confirmButtonText: "ตกลง"
    });

    // Initially show login page and hide app content
    loginPage.classList.remove('hidden');
    appPage.classList.add('hidden');
    
    // Set login page as active navigation
    navLinks.forEach(link => {
        if (link.dataset.page === 'login-page') {
            link.classList.add('bg-gray-200', 'font-bold');
        } else {
            link.classList.remove('bg-gray-200', 'font-bold');
        }
    });
    
    // Load all master data in background
    await loadAllMasterData();
    
    // Login functionality script
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        // Validate login using Google Sheet user data
        const user = masterData.users.find(u => 
            u.ID13 === username && u.Password === password
        );

        if (user) {
            // Store current user information
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            
            await Swal.fire({
                title: `ยินดีต้อนรับ ${user.ชื่อ || user.Name}!`,
                text: 'เข้าสู่ระบบสำเร็จ',
                icon: 'success',
                confirmButtonText: 'ตกลง',
                timer: 2000
            });
            
            loginPage.classList.add('hidden');
            appPage.classList.remove('hidden');
            
            // Update navigation to show user info and logout button
            updateNavigationForLoggedInUser(user);
            
            // Show first main page after login (บันทึกข้อมูล)
            showPage('record-form-page');
        } else {
            await Swal.fire({
                title: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง',
                text: 'กรุณาตรวจสอบข้อมูลและลองอีกครั้ง',
                icon: 'error',
                confirmButtonText: 'ลองอีกครั้ง'
            });
        }
    });
});

// Additional Settings Pages Functions
function renderShiftsPage() {
    const container = document.getElementById('shifts-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการเวร</h2>
            <p class="text-gray-600">หน้านี้สำหรับจัดการข้อมูลเวรการทำงาน</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">เวร</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">เช้า</td>
                            <td class="px-6 py-4 whitespace-nowrap">06:00 - 14:00</td>
                        </tr>
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">บ่าย</td>
                            <td class="px-6 py-4 whitespace-nowrap">14:00 - 22:00</td>
                        </tr>
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">ดึก</td>
                            <td class="px-6 py-4 whitespace-nowrap">22:00 - 06:00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderPatientTypesPage() {
    const container = document.getElementById('patient-types-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการประเภทผู้ป่วย</h2>
            <p class="text-gray-600">หน้านี้สำหรับจัดการข้อมูลประเภทผู้ป่วย</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ประเภท</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">คำอธิบาย</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">นอก (OPD)</td>
                            <td class="px-6 py-4 whitespace-nowrap">ผู้ป่วยนอก</td>
                        </tr>
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">ใน (IPD)</td>
                            <td class="px-6 py-4 whitespace-nowrap">ผู้ป่วยใน</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderPlacesPage() {
    const container = document.getElementById('places-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการสถานที่</h2>
            <p class="text-gray-600">หน้านี้สำหรับจัดการข้อมูลสถานที่</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อสถานที่</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${masterData.places.length > 0 ? masterData.places.map(place => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${place.Name || ''}</td>
                            </tr>
                        `).join('') : `<tr><td class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลสถานที่</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderProcessesPage() {
    const container = document.getElementById('processes-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการกระบวนการ</h2>
            <p class="text-gray-600">หน้านี้สำหรับจัดการข้อมูลกระบวนการ</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อกระบวนการ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${masterData.processes.length > 0 ? masterData.processes.map(process => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${process.Name || ''}</td>
                            </tr>
                        `).join('') : `<tr><td class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลกระบวนการ</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderCausesPage() {
    const container = document.getElementById('causes-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการสาเหตุ</h2>
            <p class="text-gray-600">หน้านี้สำหรับจัดการข้อมูลสาเหตุ</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อสาเหตุ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${masterData.causes.length > 0 ? masterData.causes.map(cause => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${cause.Name || ''}</td>
                            </tr>
                        `).join('') : `<tr><td class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลสาเหตุ</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
