<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow">
    <title>ระบบบันทึกความคลาดเคลื่อนทางยา</title>
    
    <!-- Add polyfills for older browsers -->
    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6,fetch,Promise"></script> -->
    <!-- Polyfill CDN commented out due to DNS error. 
         If you need polyfills, use a local fallback or another CDN. -->
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Sarabun font for Thai language support and overall aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for data visualization - Updated to latest version (UMD build for browser compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            min-height: 100vh;
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content { 
            background-color: #fefefe; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
            max-width: 500px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        
        .loader { 
            border: 8px solid #f3f3f3; 
            border-top: 8px solid #3498db; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            animation: spin 2s linear infinite; 
            margin: 0 auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .searchable-dropdown-list { 
            max-height: 200px; 
            overflow-y: auto; 
        }
        
        /* Fallback for CSS Grid */
        @supports not (display: grid) {
            .grid {
                display: flex;
                flex-wrap: wrap;
            }
            .grid > * {
                margin: 0.5rem;
            }
        }
        
        /* Better print styles */
        @media print {
            .no-print, nav, .modal {
                display: none !important;
            }
            .page-content {
                display: block !important;
            }
            body {
                background: white !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .bg-gray-100 {
                background-color: white !important;
            }
            .text-gray-500 {
                color: black !important;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .loader {
                animation: none;
            }
            * {
                transition: none !important;
                animation: none !important;
            }
        }
        
        /* Focus indicators for accessibility */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #10b981;
            outline-offset: 2px;
        }
        
        /* Loading state */
        .loading {
            pointer-events: none;
            opacity: 0.6;
        }
        
        /* Error handling styles */
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        
        .success-message {
            background-color: #dcfce7;
            border: 1px solid #86efac;
            color: #16a34a;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="fixed top-0 left-0 right-0 z-50" style="height: 6px; background: linear-gradient(90deg, #10b981 0%, #2563eb 100%);"></div>
    <div id="app" style="padding-top: 6px;">
        <nav class="bg-white shadow-md border-b-4 border-emerald-500 sticky top-1.5 z-40">
            <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="font-bold text-emerald-600">Pre-Dispensing Report</span>
                        <div class="hidden md:block">
                            <div class="flex items-baseline ml-10 space-x-4">
                                <button data-page="record-form-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">บันทึกข้อมูล</button>
                                <button data-page="records-list-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">รายการล่าสุด</button>
                                <button data-page="dashboard-page" class="nav-link px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200">Dashboard</button>
                                <div class="relative group">
                                    <button class="px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200 flex items-center">
                                        การตั้งค่า
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                        <div class="py-1">
                                            <button data-page="users-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ผู้ใช้งาน</button>
                                            <button data-page="medicines-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">รายการยา</button>
                                            <button data-page="shifts-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">เวร</button>
                                            <button data-page="patient-types-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ประเภทผู้ป่วย</button>
                                            <button data-page="places-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">สถานที่</button>
                                            <button data-page="processes-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">กระบวนการ</button>
                                            <button data-page="causes-page" class="nav-link block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">สาเหตุ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                    <div class="flex items-center">
                        <span id="user-display" class="ml-4 text-sm font-bold text-emerald-700"></span>
                        <button id="logout-btn" class="ml-4 px-3 py-1 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 hidden">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </nav>
        <main class="p-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <div id="record-form-page" class="page-content hidden"></div>
            <div id="records-list-page" class="page-content hidden"></div>
            <div id="dashboard-page" class="page-content hidden"></div>
            <div id="users-page" class="page-content hidden"></div>
            <div id="medicines-page" class="page-content hidden"></div>
            <div id="shifts-page" class="page-content hidden"></div>
            <div id="patient-types-page" class="page-content hidden"></div>
            <div id="places-page" class="page-content hidden"></div>
            <div id="processes-page" class="page-content hidden"></div>
            <div id="causes-page" class="page-content hidden"></div>
            <div id="error-types-page" class="page-content hidden"></div>
        </main>
    </div>
    <div id="login-page" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-30">
        <div class="p-6 bg-white rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="mb-6 text-xl font-bold text-gray-800">ลงชื่อเข้าใช้งาน</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">ID (13 หลัก)</label>
                    <input type="text" id="username" name="username" required maxlength="13" pattern="\d{13}" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="กรุณากรอก ID 13 หลัก">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="password" name="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full px-4 py-2 text-white bg-emerald-500 rounded-md hover:bg-emerald-600">เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>
    <div id="loading-modal" class="modal">
      <div class="modal-content">
        <div class="loader"></div>
        <p id="loading-text" class="mt-4 text-lg">กำลังบันทึกข้อมูล...</p>
      </div>
    </div>
    <div id="success-modal" class="modal" style="display: none !important;">
      <div class="modal-content">
        <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <p class="mt-4 text-lg">บันทึกข้อมูลสำเร็จ!</p>
        <button onclick="document.getElementById('success-modal').style.display='none'" class="px-4 py-2 mt-4 text-white bg-emerald-500 rounded-md">ตกลง</button>
      </div>
    </div>
    <script>
// --- Enhanced Configuration with Error Handling ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFrW_xMdCukPq_nx3FsoYHxxq3hH5hSRtvIKfAioJfqet_MKAJjACugUQ-X6ngZ1NqyQ/exec";

// Request timeout configuration
const REQUEST_TIMEOUT = 30000; // 30 seconds

// --- Enhanced Global State with Validation ---
let masterData = {
    users: [],        // List of all users for authentication and dropdowns
    medicines: [],    // List of all medicines with HAD status
    places: [],       // List of places/locations where errors occur
    processes: [],    // List of processes involved in medication errors
    causes: [],       // List of causes for medication errors
    records: [],      // List of all recorded medication errors
    shifts: [],       // List of shifts
    patientTypes: []  // List of patient types
};
let currentPage = 1;      // Current page number for pagination
let itemsPerPage = 10;    // Number of items to display per page
let currentRecordsPerPage = 10;

function renderRecordsList() {
    const container = document.getElementById('records-list-page');
    if (!container) return;
    if (!masterData.records || masterData.records.length === 0) {
        container.innerHTML = '<div class="p-6 bg-white rounded-lg shadow-md">ไม่มีข้อมูลรายการล่าสุด</div>';
        return;
    }
    // ฟังก์ชันแปลงวันที่เป็น yyyy-mm-dd
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    // กำหนดจำนวนรายการที่แสดง
    const perPageOptions = [10, 30, 50, 100];
    // สร้างเลขที่รายงาน (ลำดับล่าสุด = 1)
    const sortedRecords = [...masterData.records].sort((a, b) => new Date(b['วันที่เกิดเหตุการณ์']) - new Date(a['วันที่เกิดเหตุการณ์']));
    sortedRecords.forEach((r, idx) => r.__reportNo = idx + 1);
    // จำนวนที่จะแสดง
    const showCount = currentRecordsPerPage;
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">รายการล่าสุด</h2>
            <div class="mb-4 flex items-center gap-2">
                <label for="records-per-page" class="text-sm">แสดง</label>
                <select id="records-per-page" class="border border-gray-300 rounded px-2 py-1">
                    ${perPageOptions.map(opt => `<option value="${opt}" ${opt === showCount ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
                <span class="text-sm">รายการ</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">เลขที่รายงาน</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">วันที่เกิดเหตุการณ์</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">เวร</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">สถานที่</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">กระบวนการ</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">ข้อผิดพลาด</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">รายการยาที่ผิด</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">สาเหตุ</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">ผู้บันทึก</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedRecords.slice(0, showCount).map(r => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-4 py-2 whitespace-nowrap">${r.__reportNo}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${formatDate(r['วันที่เกิดเหตุการณ์'])}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['เวร'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['สถานที่'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['กระบวนการ'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['ข้อผิดพลาด'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['รายการยาที่ผิด'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['สาเหตุ'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['ผู้บันทึก'] || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    // เพิ่ม event เปลี่ยนจำนวนรายการ
    const perPageSelect = document.getElementById('records-per-page');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', (e) => {
            currentRecordsPerPage = parseInt(e.target.value, 10) || 10;
            renderRecordsList();
        });
    }
}
// --- Enhanced Utility Functions ---

/**
 * Input sanitization function
 */
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                .replace(/<[^>]*>/g, '')
                .replace(/javascript:/gi, '')
                .trim();
}

/**
 * Debounce function for performance optimization
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Enhanced error handling with network status detection
 */
function getErrorMessage(error) {
    if (!navigator.onLine) {
        return 'ไม่มีการเชื่อมต่ออินเทอร์เน็ต กรุณาตรวจสอบการเชื่อมต่อ';
    }
    
    if (error.name === 'AbortError') {
        return 'หมดเวลาการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง';
    }
    
    if (error.message.includes('Failed to fetch')) {
        return 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาลองใหม่อีกครั้ง';
    }
    
    return error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
}

/**
 * Enhanced fetch function with timeout and retry logic
 */
async function fetchWithTimeout(url, options = {}) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
    try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) {
            // Show error in UI if 404
            if (response.status === 404) {
                showGlobalError(`Resource not found (404): ${url}`);
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        showGlobalError(getErrorMessage(error));
        throw error;
    }
}

// --- Global error display ---
function showGlobalError(message) {
    let errorDiv = document.getElementById('global-error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'global-error-message';
        errorDiv.className = 'error-message fixed top-0 left-0 right-0 z-50';
        document.body.prepend(errorDiv);
    }
    errorDiv.innerHTML = `<strong>เกิดข้อผิดพลาด:</strong> ${message}`;
    setTimeout(() => {
        if (errorDiv) errorDiv.remove();
    }, 10000); // Hide after 10 seconds
}

// --- DOM Elements Caching ---
const appPage = document.getElementById('app');
const navLinks = document.querySelectorAll('.nav-link'); // All navigation buttons
const loadingModal = document.getElementById('loading-modal');
const successModal = document.getElementById('success-modal');
const loginPage = document.getElementById('login-page');
const loginForm = document.getElementById('login-form');
const logoutBtn = document.getElementById('logout-btn');

// --- Navigation Event Listeners ---
navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        const pageId = link.dataset.page;
        if (pageId) {
            showPage(pageId);
        }
    });
});
if (logoutBtn) {
    logoutBtn.addEventListener('click', logout);
}

// --- App Initialization ---
async function initializeApp() {
    try {
        console.log('กำลังโหลดข้อมูลเริ่มต้น...');
        // Load users data for login
        const usersResponse = await fetch(`${SCRIPT_URL}?action=getusers`);
        if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            if (usersData.status === 'success') {
                masterData.users = usersData.result || [];
                console.log('โหลดข้อมูลผู้ใช้สำเร็จ:', masterData.users.length, 'คน');
            }
        }
        // Load other reference data
        const endpoints = ['getmedicines', 'getplaces', 'getprocesses', 'getcauses', 'geterrortypes'];
        const keys = ['medicines', 'places', 'processes', 'causes', 'errorTypes'];
        for (let i = 0; i < endpoints.length; i++) {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=${endpoints[i]}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        masterData[keys[i]] = data.result || [];
                        console.log(`โหลด${keys[i]}สำเร็จ:`, masterData[keys[i]].length, 'รายการ');
                    }
                }
            } catch (error) {
                console.error(`Failed to load ${keys[i]}:`, error);
            }
        }
        // Load records after other master data
        masterData.records = await fetchDataFromSheet('getRecords');
        masterData.records.sort((a,b) => new Date(b.วันที่เกิดเหตุการณ์) - new Date(a.วันที่เกิดเหตุการณ์));
        // Hide app until login
        appPage.style.display = 'none';
        loginPage.style.display = 'flex';
        updateUserDisplay();
        // If already logged in, show app
        const currentUser = getCurrentUser();
        if (currentUser) {
            loginPage.style.display = 'none';
            appPage.style.display = 'block';
            updateUserDisplay();
            showPage('record-form-page');
        }
    } catch (error) {
        console.error('Failed to load initial data:', error);
        // Fallback: use mock data for demo/offline
        masterData.users = [
            { ID13: '1234567890123', Password: 'test', Name: 'Demo User', Position: 'Pharmacist' }
        ];
        masterData.medicines = [
            { Name: 'Paracetamol', HAD: 'no' },
            { Name: 'Morphine', HAD: 'yes' }
        ];
        masterData.places = [ { Name: 'หอผู้ป่วย 1' }, { Name: 'ห้องจ่ายยา' } ];
        masterData.processes = [ { 'กระบวนการ': 'จัดยา' }, { 'กระบวนการ': 'ลงข้อมูล' } ];
        masterData.causes = [ { Name: 'ลืม' }, { Name: 'สื่อสารผิด' } ];
        masterData.errorTypes = [
            'ไม่ติดฉลากยา',
            'จัดผิดขนาด',
            'จัดผิดจำนวน',
            'จัดไม่ครบชนิด',
            'จัดผิดชนิด',
            'จัดผิดรูปแบบ',
            'จัดผิดคน',
            'key ผิดขนาด',
            'key ผิดจำนวน',
            'key ไม่ครบชนิด',
            'key ผิดคน',
            'key ผิดวิธีใช้',
            'ลงข้อมูลก่อนเตรียมยาไม่ถูกต้อง',
            'ลืมเตรียมยา',
            'ไม่ได้ส่งการปรับปรุง order/stat',
            'ไม่ได้อ่าน line ทำให้ไมไ่ด้เตรียมยา',
            'ผลิตยาไม่ทัน',
            'ติดฉลกายา prepack ผิดชนิด',
            'ตรวจพบยาหมดอายุในจุดจ่าย',
            'ไม่ได้ลงค่าใช้จ่ายด้านยา(ไมไ่ด้คิดค่ายาหรือเวชภัณฑ์อื่นๆ)',
            'ไม่ได้หยุดยา/นำยาออก กรณีแพทย์สั่ง off ยา',
            'เก็บยาผิดตำแหน่ง',
            'คีย์สารละลายผิดขนาด ผิดชนิด',
            'ไม่ได้เตรียม set IV เพื่อยาเคมีบำบัด'
        ];
        masterData.records = [
            { 'วันที่เกิดเหตุการณ์': '2025-07-01', 'เวร': 'เช้า', 'สถานที่': 'หอผู้ป่วย 1', 'กระบวนการ': 'จัดยา', 'ข้อผิดพลาด': 'จัดผิดขนาด', 'รายการยาที่ผิด': 'Paracetamol', 'สาเหตุ': 'ลืม', 'ผู้บันทึก': 'Demo User' },
            { 'วันที่เกิดเหตุการณ์': '2025-06-30', 'เวร': 'บ่าย', 'สถานที่': 'ห้องจ่ายยา', 'กระบวนการ': 'ลงข้อมูล', 'ข้อผิดพลาด': 'ไม่ติดฉลากยา', 'รายการยาที่ผิด': 'Morphine', 'สาเหตุ': 'ลืม', 'ผู้บันทึก': 'Demo User' },
            { 'วันที่เกิดเหตุการณ์': '2025-06-25', 'เวร': 'ดึก', 'สถานที่': 'หอผู้ป่วย 1', 'กระบวนการ': 'จัดยา', 'ข้อผิดพลาด': 'จัดผิดชนิด', 'รายการยาที่ผิด': 'Paracetamol', 'สาเหตุ': 'สื่อสารผิด', 'ผู้บันทึก': 'Demo User' }
        ];
        showGlobalError('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์จริง กำลังใช้ข้อมูลตัวอย่างสำหรับการทดสอบ');
        appPage.style.display = 'none';
        loginPage.style.display = 'flex';
        updateUserDisplay();
    }
}

// --- On page load, initialize app ---
window.addEventListener('DOMContentLoaded', initializeApp);

// Ensure login form event is always attached
if (loginForm) {
    loginForm.addEventListener('submit', handleLogin);
}

// --- Enhanced Network Status Detection ---
window.addEventListener('online', () => {
    console.log('กลับมาออนไลน์แล้ว - ระบบพร้อมใช้งาน');
});

window.addEventListener('offline', () => {
    console.log('ไม่มีการเชื่อมต่ออินเทอร์เน็ต - ระบบอาจทำงานไม่ปกติ');
});

// --- Enhanced Error Boundary ---
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    // Don't show error to user for script errors, just log them
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    event.preventDefault(); // Prevent default browser error handling
});

// --- Authentication & Session Management ---

/**
 * Gets the current logged-in user from sessionStorage.
 * @returns {Object|null} - The current user object or null if not logged in.
 */
function getCurrentUser() {
    try {
        const userData = sessionStorage.getItem('currentUser');
        return userData ? JSON.parse(userData) : null;
    } catch (error) {
        console.error('Error parsing user data:', error);
        sessionStorage.removeItem('currentUser');
        return null;
    }
}

/**
 * Sets the current logged-in user in sessionStorage.
 * @param {Object} user - The user object to set as current user.
 */
function setCurrentUser(user) {
    try {
        sessionStorage.setItem('currentUser', JSON.stringify(user));
    } catch (error) {
        console.error('Error saving user data:', error);
        console.log('ไม่สามารถบันทึกข้อมูลผู้ใช้ได้');
    }
}

/**
 * Logs out the current user by clearing session data and showing login page.
 */
function logout() {
    sessionStorage.removeItem('currentUser');
    updateUserDisplay(); // อัพเดตการแสดงชื่อผู้ใช้ใน navbar
    loginPage.style.display = 'flex';
    appPage.style.display = 'none';
    // เคลียร์ฟอร์ม login
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
}

/**
 * อัพเดตการแสดงชื่อผู้ใช้ใน navbar
 */
function updateUserDisplay() {
    const currentUser = getCurrentUser();
    const userDisplay = document.getElementById('user-display');
    const logoutBtn = document.getElementById('logout-btn');
    
    if (currentUser && userDisplay) {
        // Updated to use correct column names: Name, Position
        const displayName = currentUser.Name || 'ไม่ระบุ';
        const position = currentUser.Position ? ` (${currentUser.Position})` : '';
        userDisplay.textContent = `ผู้ใช้: ${displayName}${position}`;
        logoutBtn.classList.remove('hidden');
    } else if (userDisplay) {
        userDisplay.textContent = '';
        logoutBtn.classList.add('hidden');
    }
}

/**
 * Handles user login authentication.
 * @param {Event} e - The form submission event.
 */
async function handleLogin(e) {
    e.preventDefault();
    
    const username = sanitizeInput(document.getElementById('username').value.trim());
    const password = sanitizeInput(document.getElementById('password').value.trim());
    
    if (!username || !password) {
        showError('กรุณากรอก ID และรหัสผ่าน');
        return;
    }
    
    if (username.length !== 13 || !/^\d{13}$/.test(username)) {
        showError('ID ต้องเป็นตัวเลข 13 หลัก');
        return;
    }
    
    showLoading('กำลังตรวจสอบข้อมูลผู้ใช้...');
    
    try {
        // Find user in masterData.users array - updated for correct column names
        const user = masterData.users.find(u => u.ID13 === username && u.Password === password);
        
        if (user) {
            setCurrentUser(user);
            updateUserDisplay();
            loginPage.style.display = 'none';
            appPage.style.display = 'block';
            // Fetch all master data after login
            showLoading('กำลังโหลดข้อมูล...');
            try {
                masterData.medicines = await fetchDataFromSheet('getmedicines');
                masterData.places = await fetchDataFromSheet('getplaces');
                masterData.processes = await fetchDataFromSheet('getprocesses');
                masterData.causes = await fetchDataFromSheet('getcauses');
                masterData.records = await fetchDataFromSheet('getRecords');
                masterData.records.sort((a,b) => new Date(b.วันที่เกิดเหตุการณ์) - new Date(a.วันที่เกิดเหตุการณ์));
            } catch (err) {
                // fallback: keep old data
            }
            hideLoading();
            showPage('record-form-page');
            console.log('เข้าสู่ระบบสำเร็จ');
            
            // Clear login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        } else {
            showError('ID หรือรหัสผ่านไม่ถูกต้อง');
        }
    } catch (error) {
        console.error('Login error:', error);
        showError('เกิดข้อผิดพลาดในการเข้าสู่ระบบ');
    } finally {
        hideLoading();
    }
}

// ฟังก์ชันแจ้งเตือนด้วย SweetAlert2 with Enhanced Validation
function showError(message) {
    if (!message || typeof message !== 'string') {
        message = 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
    }
    
    Swal.fire({
        title: 'เกิดข้อผิดพลาด!',
        text: sanitizeInput(message),
        icon: 'error',
        confirmButtonText: 'ตกลง',
        customClass: {
            container: 'swal-container'
        }
    });
}

function showSuccess(message = 'ดำเนินการสำเร็จ!') {
    // Suppressed SweetAlert2 popup for better UX - log to console instead
    console.log('Success:', sanitizeInput(message));
}

function showInfo(message) {
    Swal.fire({
        title: 'แจ้งเตือน',
        text: sanitizeInput(message),
        icon: 'info',
        confirmButtonText: 'ตกลง',
        customClass: {
            container: 'swal-container'
        }
    });
}

async function showConfirm(message) {
    const result = await Swal.fire({
        title: 'ยืนยัน',
        text: sanitizeInput(message),
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ตกลง',
        cancelButtonText: 'ยกเลิก',
        customClass: {
            container: 'swal-container'
        }
    });
    return result.isConfirmed;
}

// --- Enhanced Utility Functions ---

/**
 * Displays the loading modal with a customizable message.
 * @param {string} text - The message to display in the loading modal.
 */
function showLoading(text = 'กำลังโหลดข้อมูล...') {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
        loadingText.textContent = sanitizeInput(text);
    }
    
    const loadingModal = document.getElementById('loading-modal');
    if (loadingModal) {
        loadingModal.style.display = 'flex'; // Use flex to center the modal content
    }
}

/**
 * Hides the loading modal.
 */
function hideLoading() {
    const loadingModal = document.getElementById('loading-modal');
    if (loadingModal) {
        loadingModal.style.display = 'none';
    }
}

/**
 * Displays the success modal.
 */
function showSuccess() {
    // Suppressed success modal for better UX - log to console instead
    const currentUser = getCurrentUser();
    if (currentUser) {
        console.log('Record saved successfully');
    }
}

/**
 * Shows a specific application page and hides all others.
 * Also updates the active state of navigation links.
 * @param {string} pageId - The ID of the page to show.
 */
function showPage(pageId) {
    // Hide all page content divs
    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
    // Show the requested page
    document.getElementById(pageId).classList.remove('hidden');
    
    // Update active navigation link style
    navLinks.forEach(link => {
        if (link.dataset.page === pageId) {
            link.classList.add('bg-gray-200', 'font-bold'); // Add active styles
        } else {
            link.classList.remove('bg-gray-200', 'font-bold'); // Remove active styles
        }
    });    /* Render content specific to the selected page */
    switch (pageId) {
        case 'login-page':
            // Don't render anything special for login page, it's already in HTML
            break;
        case 'records-list-page': renderRecordsList(); break;
        case 'record-form-page': renderRecordForm(); break;
        case 'dashboard-page': renderDashboard(); break;
        case 'users-page': renderUsersPage(); break;
        case 'medicines-page': renderMedicinesPage(); break;
        case 'shifts-page': renderShiftsPage(); break;
        case 'patient-types-page': renderPatientTypesPage(); break;
        case 'places-page': renderPlacesPage(); break;
        case 'processes-page': renderProcessesPage(); break;
        case 'causes-page': renderCausesPage(); break;
        case 'error-types-page': renderErrorTypesPage(); break;
    }
}

/**
 * Renders the record form page for entering medication error data.
 */
function renderRecordForm() {
    const container = document.getElementById('record-form-page');
    
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">บันทึกรายการความคลาดเคลื่อนทางยา</h2>
            <form id="record-form" class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div>
                    <label for="event_date" class="block text-sm font-medium text-gray-700">วันที่เกิดเหตุการณ์</label>
                    <input type="date" id="event_date" name="event_date" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="shift" class="block text-sm font-medium text-gray-700">เวร</label>
                    <select id="shift" name="shift" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        <option value="เช้า">เช้า</option>
                        <option value="บ่าย">บ่าย</option>
                        <option value="ดึก">ดึก</option>
                    </select>
                </div>
                <div>
                    <label for="patient_type" class="block text-sm font-medium text-gray-700">ประเภทผู้ป่วย</label>
                    <select id="patient_type" name="patient_type" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        <option value="นอก">นอก (OPD)</option>
                        <option value="ใน">ใน (IPD)</option>
                    </select>
                </div>
                <div>
                    <label for="place" class="block text-sm font-medium text-gray-700">สถานที่</label>
                    <select id="place" name="place" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        ${(masterData.places || []).map(p => `<option value="${p.Name || p.name || ''}">${p.Name || p.name || ''}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="process" class="block text-sm font-medium text-gray-700">กระบวนการ</label>
                    <select id="process" name="process" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>เลือก...</option>
                        ${(masterData.processes || []).map(p => `<option value="${p['กระบวนการ'] || p.Name || p.name || ''}">${p['กระบวนการ'] || p.Name || p.name || ''}</option>`).join('')}
                        <option value="อื่นๆ">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" id="process_other" name="process_other" class="hidden w-full px-3 py-2 mt-2 border border-gray-300 rounded-md" placeholder="ระบุกระบวนการอื่นๆ">
                </div>
                <div>
                    <label for="error_type" class="block text-sm font-medium text-gray-700">ข้อผิดพลาด</label>
                    <select id="error_type" name="error_type" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                        <option value="" selected>กรุณาเลือกกระบวนการก่อน</option>
                    </select>
                    <input type="text" id="error_type_other" name="error_type_other" class="hidden w-full px-3 py-2 mt-2 border border-gray-300 rounded-md" placeholder="ระบุข้อผิดพลาดอื่นๆ">
                </div>
                <div>
                    <label for="correct_medicine_search" class="block text-sm font-medium text-gray-700">รายการยาที่ถูกต้อง</label>
                    <input type="text" id="correct_medicine_search" name="correct_medicine_search" list="medicine-list" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="ค้นหายา...">
                </div>
                <div>
                    <label for="incorrect_medicine_search" class="block text-sm font-medium text-gray-700">รายการยาที่ผิด</label>
                    <input type="text" id="incorrect_medicine_search" name="incorrect_medicine_search" list="medicine-list" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md" placeholder="ค้นหายา...">
                </div>
                <datalist id="medicine-list">
                    ${(masterData.medicines || []).map(m => `<option value="${m.Name || m.name || ''}" data-code="${m.Code || ''}">`).join('')}
                </datalist>
                <div class="p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2">
                    <p class="font-bold text-teal-800">High Alert Drug (HAD)</p>
                    <p id="had_status" class="text-teal-700">กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD</p>
                </div>
                <div class="md:col-span-2">
                    <label for="cause" class="block text-sm font-medium text-gray-700">สาเหตุ</label>
                    <select id="cause" name="cause" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md">
                       <option value="" selected>เลือก...</option>
                       ${(masterData.causes || []).map(c => `<option value="${c.Name || c.name || ''}">${c.Name || c.name || ''}</option>`).join('')}
                       <option value="อื่นๆ">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" id="cause_other" name="cause_other" class="hidden w-full px-3 py-2 mt-2 border border-gray-300 rounded-md" placeholder="ระบุสาเหตุอื่นๆ">
                </div>
                <div class="md:col-span-2">
                    <label for="details" class="block text-sm font-medium text-gray-700">รายละเอียดเพิ่มเติม</label>
                    <textarea id="details" name="details" rows="4" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md"></textarea>
                </div>
                <div>
                    <label for="reporter" class="block text-sm font-medium text-gray-700">ผู้บันทึก</label>
                    <input type="text" id="reporter" name="reporter" readonly class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
                </div>
                <div class="md:col-span-2 flex justify-end gap-2 mt-4">
                    <button type="button" id="reset-form-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">ล้างข้อมูล</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    `;
    
    // Set default date for new record form to today
    document.getElementById('event_date').valueAsDate = new Date();
    
    // Set reporter name from current user - updated for correct User sheet columns
    const currentUser = getCurrentUser();
    const reporterField = document.getElementById('reporter');
    if (reporterField && currentUser) {
        const reporterName = currentUser.Name || 'ไม่ระบุ';
        reporterField.value = reporterName;
        reporterField.dataset.reporterId = currentUser.ID13 || '';
    }

    // Setup form event listeners after rendering
    setupFormEventListeners();
}

// --- Enhanced Data Fetching Functions ---

/**
 * Enhanced data fetching with improved error handling and retry logic
 */
async function fetchDataFromSheet(action, retryCount = 0) {
    const maxRetries = 2;
    
    showLoading(`กำลังโหลดข้อมูล ${action.replace('get', '')} ...`);
    
    try {
        const response = await fetchWithTimeout(`${SCRIPT_URL}?action=${action}`);
        const data = await response.json();
        return data.result || [];
    } catch (error) {
        console.error(`Error fetching ${action}:`, error);
        
        // Retry logic for network errors
        if (retryCount < maxRetries && (error.name === 'AbortError' || error.message.includes('Failed to fetch'))) {
            console.log(`Retrying ${action} (attempt ${retryCount + 1}/${maxRetries})`);
            await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // Exponential backoff
            return fetchDataFromSheet(action, retryCount + 1);
        }
        
        const currentUser = getCurrentUser();
        if (currentUser) {
            console.log(`เกิดข้อผิดพลาดในการดึงข้อมูล: ${getErrorMessage(error)}`);
        }
        return [];
    } finally {
        hideLoading();
    }
}

/**
 * Enhanced form submission with validation and sanitization
 */
async function handleRecordSubmit(e) {
    e.preventDefault(); // Prevent default form submission

    const form = e.target;
    const formData = new FormData(form);
    const recordData = {};

    // Collect and sanitize data from form fields
    for (let [key, value] of formData.entries()) {
        recordData[key] = sanitizeInput(value);
    }

    // Validate required fields
    const requiredFields = ['event_date', 'shift', 'patient_type', 'place', 'process', 'error_type', 'incorrect_medicine_search', 'cause'];
    const missingFields = requiredFields.filter(field => {
        const value = recordData[field] || document.getElementById(field)?.value;
        return !value || value.trim() === '';
    });

    if (missingFields.length > 0) {
        showError('กรุณากรอกข้อมูลให้ครบถ้วน: ' + missingFields.join(', '));
        return;
    }

    // Process special fields
    const processSelect = document.getElementById('process');
    const processOtherInput = document.getElementById('process_other');
    if (processSelect.value === 'อื่นๆ') {
        if (!processOtherInput.value.trim()) {
            showError('กรุณาระบุกระบวนการอื่นๆ');
            return;
        }
        recordData['กระบวนการ'] = sanitizeInput(processOtherInput.value);
    } else {
        recordData['กระบวนการ'] = processSelect.value;
    }

    // Process error type
    const errorTypeSelect = document.getElementById('error_type');
    const errorTypeOtherInput = document.getElementById('error_type_other');
    if (errorTypeSelect.value === 'อื่นๆ') {
        if (!errorTypeOtherInput.value.trim()) {
            showError('กรุณาระบุข้อผิดพลาดอื่นๆ');
            return;
        }
        recordData['ข้อผิดพลาด'] = sanitizeInput(errorTypeOtherInput.value);
    } else {
        recordData['ข้อผิดพลาด'] = errorTypeSelect.value;
    }

    // HAD calculation
    const correctMedName = document.getElementById('correct_medicine_search').value;
    const incorrectMedName = document.getElementById('incorrect_medicine_search').value;
    const correctMed = masterData.medicines.find(m => m.Name === correctMedName);
    const incorrectMed = masterData.medicines.find(m => m.Name === incorrectMedName);
    const isHad = (correctMed && correctMed.HAD && String(correctMed.HAD).toLowerCase() === 'yes') ||
                  (incorrectMed && incorrectMed.HAD && String(incorrectMed.HAD).toLowerCase() === 'yes');
    recordData['HAD'] = isHad ? 'HAD' : '';

    // Process cause
    const causeSelect = document.getElementById('cause');
    const causeOtherInput = document.getElementById('cause_other');
    if (causeSelect.value === 'อื่นๆ') {
        if (!causeOtherInput.value.trim()) {
            showError('กรุณาระบุสาเหตุอื่นๆ');
            return;
        }
        recordData['สาเหตุ'] = sanitizeInput(causeOtherInput.value);
    } else {
        recordData['สาเหตุ'] = causeSelect.value;
    }

    // Reporter information
    const reporterField = document.getElementById('reporter');
    const currentUser = getCurrentUser();
    if (reporterField && reporterField.value) {
        recordData['ผู้บันทึก'] = sanitizeInput(reporterField.value);
        recordData['ผู้บันทึก_ID'] = reporterField.dataset.reporterId || '';
    } else {
        recordData['ผู้บันทึก'] = currentUser ? (currentUser.Name || 'ไม่ระบุ') : 'ไม่ระบุ';
        recordData['ผู้บันทึก_ID'] = currentUser ? (currentUser.ID13 || '') : '';
    }

    // Prepare data for submission - matching Google Apps Script parameters
    const dataToSend = {
        action: 'addrecord',
        'วันที่เกิดเหตุการณ์': recordData['event_date'],
        'เวร': recordData['shift'],
        'ประเภทผู้ป่วย': recordData['patient_type'],
        'สถานที่': recordData['place'],
        'กระบวนการ': recordData['กระบวนการ'],
        'ข้อผิดพลาด': recordData['ข้อผิดพลาด'],
        'รายการยาที่ถูกต้อง': recordData['correct_medicine_search'],
        'รายการยาที่ผิด': recordData['incorrect_medicine_search'],
        'HAD': recordData['HAD'],
        'สาเหตุ': recordData['สาเหตุ'],
        'รายละเอียด': recordData['details'], 
        'ผู้บันทึก': recordData['ผู้บันทึก'],
        'ผู้บันทึก_ID': recordData['ผู้บันทึก_ID']
    };

    const queryParams = new URLSearchParams(dataToSend).toString();
    
    showLoading('กำลังบันทึกข้อมูล...');
    
    try {
        // Disable form during submission
        form.classList.add('loading');
        
        const response = await fetchWithTimeout(`${SCRIPT_URL}?${queryParams}`);
        const result = await response.json();

        if (result.status === 'success') {
            console.log('บันทึกข้อมูลสำเร็จ!');
            form.reset();
            document.getElementById('event_date').valueAsDate = new Date();
            
            // Set reporter name again after reset
            const reporterField = document.getElementById('reporter');
            if (reporterField && currentUser) {
                const reporterName = currentUser.Name || 'ไม่ระบุ';
                reporterField.value = reporterName;
                reporterField.dataset.reporterId = currentUser.ID13 || '';
            }
            
            // Reload records data
            masterData.records = await fetchDataFromSheet('getRecords');
            masterData.records.sort((a,b) => new Date(b.วันที่เกิดเหตุการณ์) - new Date(a.วันที่เกิดเหตุการณ์));
            
            // Reset HAD status
            const hadStatus = document.getElementById('had_status');
            if (hadStatus) {
                hadStatus.textContent = 'กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD';
                hadStatus.parentElement.className = 'p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2';
            }
            
            // Reset process and error type dropdowns
            const processSelect = document.getElementById('process');
            const errorTypeSelect = document.getElementById('error_type');
            if (processSelect) processSelect.value = '';
            if (errorTypeSelect) {
                errorTypeSelect.innerHTML = '<option value="" selected>กรุณาเลือกกระบวนการก่อน</option>';
                errorTypeSelect.disabled = true;
            }
            
            showInfo('บันทึกข้อมูลสำเร็จ!');
        } else {
            showError(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${result.message || 'ไม่ทราบสาเหตุ'}`);
        }
    } catch (error) {
        console.error('Error submitting record:', error);
        showError(`เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${getErrorMessage(error)}`);
    } finally {
        hideLoading();
        form.classList.remove('loading');
    }
}

/**
 * Sets up all form event listeners after form rendering
 */
function setupFormEventListeners() {
    // Setup record form submit listener
    const recordForm = document.getElementById('record-form');
    if (recordForm) {
        recordForm.removeEventListener('submit', handleRecordSubmit); // Remove existing listener
        recordForm.addEventListener('submit', handleRecordSubmit);
    }
    
    // Setup medicine change listeners for HAD status
    const correctMedicineInput = document.getElementById('correct_medicine_search');
    const incorrectMedicineInput = document.getElementById('incorrect_medicine_search');
    
    const updateHADStatus = () => {
        const correctMedName = correctMedicineInput?.value || '';
        const incorrectMedName = incorrectMedicineInput?.value || '';
        
        // Updated to work with Medicine sheet structure: Code, Name, HAD
        const correctMed = masterData.medicines.find(m => m.Name === correctMedName);
        const incorrectMed = masterData.medicines.find(m => m.Name === incorrectMedName);
        
        const correctIsHad = correctMed && correctMed.HAD && String(correctMed.HAD).toLowerCase() === 'yes';
        const incorrectIsHad = incorrectMed && incorrectMed.HAD && String(incorrectMed.HAD).toLowerCase() === 'yes';
        
        const hadStatus = document.getElementById('had_status');
        if (hadStatus) {
            if (correctIsHad || incorrectIsHad) {
                hadStatus.textContent = 'ยานี้เป็น High Alert Drug (HAD)';
                hadStatus.parentElement.className = 'p-3 bg-red-100 border-l-4 border-red-500 rounded-md md:col-span-2';
            } else if (correctMedName || incorrectMedName) {
                hadStatus.textContent = 'ยานี้ไม่ใช่ High Alert Drug (HAD)';
                hadStatus.parentElement.className = 'p-3 bg-green-100 border-l-4 border-green-500 rounded-md md:col-span-2';
            } else {
                hadStatus.textContent = 'กรุณาเลือกยาเพื่อตรวจสอบสถานะ HAD';
                hadStatus.parentElement.className = 'p-3 bg-teal-100 border-l-4 border-teal-500 rounded-md md:col-span-2';
            }
        }
    };
    
    if (correctMedicineInput) correctMedicineInput.addEventListener('input', updateHADStatus);
    if (incorrectMedicineInput) incorrectMedicineInput.addEventListener('input', updateHADStatus);
    
    // Define error types for each process (กระบวนการ -> ข้อผิดพลาด mapping)
    const processErrorMapping = {
        'จัดยา': [
            'ไม่ติดฉลากยา',
            'จัดผิดขนาด',
            'จัดผิดจำนวน',
            'จัดไม่ครบชนิด',
            'จัดผิดชนิด',
            'จัดผิดรูปแบบ',
            'จัดผิดคน'
        ],
        'ลงข้อมูล': [
            'key ผิดขนาด',
            'key ผิดจำนวน',
            'key ไม่ครบชนิด',
            'key ผิดคน',
            'key ผิดวิธีใช้',
            'ลงข้อมูลก่อนเตรียมยาไม่ถูกต้อง',
            'คีย์สารละลายผิดขนาด ผิดชนิด'
        ],
        'เตรียมยา': [
            'ลืมเตรียมยา',
            'ไม่ได้ส่งการปรับปรุง order/stat',
            'ไม่ได้อ่าน line ทำให้ไม่ได้เตรียมยา',
            'ผลิตยาไม่ทัน',
            'ติดฉลากยา prepack ผิดชนิด',
            'ไม่ได้เตรียม set IV เพื่อยาเคมีบำบัด'
        ],
        'การเก็บยา': [
            'ตรวจพบยาหมดอายุในจุดจ่าย',
            'ไม่ได้ลงค่าใช้จ่ายด้านยา(ไม่ได้คิดค่ายาหรือเวชภัณฑ์อื่นๆ)',
            'เก็บยาผิดตำแหน่ง'
        ],
        'จัดส่งยา': [
            'ไม่ได้หยุดยา/นำยาออก กรณีแพทย์สั่ง off ยา'
        ]
    };
    
    // Setup process change listener
    const processSelect = document.getElementById('process');
    const processOtherInput = document.getElementById('process_other');
    const errorTypeSelect = document.getElementById('error_type');
    const errorTypeOtherInput = document.getElementById('error_type_other');
    
    if (processSelect && errorTypeSelect) {
        processSelect.addEventListener('change', () => {
            const selectedProcess = processSelect.value;
            
            // Handle process "other" input
            if (processOtherInput) {
                processOtherInput.classList.toggle('hidden', selectedProcess !== 'อื่นๆ');
                if (processOtherInput.classList.contains('hidden')) {
                    processOtherInput.value = '';
                }
            }
            
            // Update error type dropdown based on selected process
            errorTypeSelect.innerHTML = '<option value="" selected>เลือก...</option>';
            
            if (selectedProcess && selectedProcess !== 'อื่นๆ' && processErrorMapping[selectedProcess]) {
                // Add specific error types for the selected process
                processErrorMapping[selectedProcess].forEach(errorType => {
                    const option = document.createElement('option');
                    option.value = errorType;
                    option.textContent = errorType;
                    errorTypeSelect.appendChild(option);
                });
                // Add "other" option
                const otherOption = document.createElement('option');
                otherOption.value = 'อื่นๆ';
                otherOption.textContent = 'อื่นๆ (โปรดระบุ)';
                errorTypeSelect.appendChild(otherOption);
                errorTypeSelect.disabled = false;
            } else if (selectedProcess === 'อื่นๆ') {
                // If process is "other", allow manual input for error type
                const otherOption = document.createElement('option');
                otherOption.value = 'อื่นๆ';
                otherOption.textContent = 'อื่นๆ (โปรดระบุ)';
                errorTypeSelect.appendChild(otherOption);
                errorTypeSelect.disabled = false;
            } else {
                // No process selected
                errorTypeSelect.innerHTML = '<option value="" selected>กรุณาเลือกกระบวนการก่อน</option>';
                errorTypeSelect.disabled = true;
            }
            
            // Reset error type other input
            if (errorTypeOtherInput) {
                errorTypeOtherInput.classList.add('hidden');
                errorTypeOtherInput.value = '';
            }
        });
    }
    
    // Setup error type change listener
    if (errorTypeSelect && errorTypeOtherInput) {
        errorTypeSelect.addEventListener('change', () => {
            errorTypeOtherInput.classList.toggle('hidden', errorTypeSelect.value !== 'อื่นๆ');
            if (errorTypeOtherInput.classList.contains('hidden')) {
                errorTypeOtherInput.value = '';
            }
        });
    }
    
    // Setup cause change listener
    const causeSelect = document.getElementById('cause');
    const causeOtherInput = document.getElementById('cause_other');
    
    if (causeSelect && causeOtherInput) {
        causeSelect.addEventListener('change', () => {
            causeOtherInput.classList.toggle('hidden', causeSelect.value !== 'อื่นๆ');
            if (causeOtherInput.classList.contains('hidden')) {
                causeOtherInput.value = '';
            }
        });
    }
    
    // Setup reset button
    const resetBtn = document.getElementById('reset-form-btn');
    if (resetBtn && recordForm) {
        resetBtn.addEventListener('click', () => {
            recordForm.reset();
            document.getElementById('event_date').valueAsDate = new Date();
            
            // Set reporter name again after reset
            const currentUser = getCurrentUser();
            const reporterField = document.getElementById('reporter');
            if (reporterField && currentUser) {
                const reporterName = currentUser.Name || 'ไม่ระบุ';
                reporterField.value = reporterName;
                reporterField.dataset.reporterId = currentUser.ID13 || '';
            }
            
            // Reset HAD status
            updateHADStatus();
            
            // Reset process and error type dropdowns
            if (processSelect) processSelect.value = '';
            if (errorTypeSelect) {
                errorTypeSelect.innerHTML = '<option value="" selected>กรุณาเลือกกระบวนการก่อน</option>';
                errorTypeSelect.disabled = true;
            }
        });
    }
}

/**
 * Renders the users management page.
 */
function renderUsersPage() {
    const container = document.getElementById('users-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการผู้ใช้</h2>
            <p class="text-gray-600 mb-4">หน้านี้สำหรับดูข้อมูลผู้ใช้งานในระบบ</p>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ID13</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อ</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ตำแหน่ง</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ระดับ</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">PScode</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="divide-y divide-gray-200">
                        ${(masterData.users || []).length > 0 ? (masterData.users || []).map(user => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${user.ID13 || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.Name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.Position || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.Level || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.PScode || ''}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลผู้ใช้งาน</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Placeholder functions for other management pages
function renderMedicinesPage() {
    const container = document.getElementById('medicines-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการรายการยา</h2>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">รหัสยา</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อยา</th>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">HAD</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(masterData.medicines || []).map(med => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${med.Code || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${med.Name || ''}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                        (med.HAD && String(med.HAD).toLowerCase() === 'yes') 
                                            ? 'bg-red-100 text-red-800' 
                                            : 'bg-green-100 text-green-800'
                                    }">
                                        ${(med.HAD && String(med.HAD).toLowerCase() === 'yes') ? 'HAD' : 'ไม่ใช่ HAD'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderShiftsPage() {
    const container = document.getElementById('shifts-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการเวร</h2>
            <div class="space-y-2">
                <div class="p-3 bg-gray-50 rounded">เช้า</div>
                <div class="p-3 bg-gray-50 rounded">บ่าย</div>
                <div class="p-3 bg-gray-50 rounded">ดึก</div>
            </div>
        </div>
    `;
}

function renderPatientTypesPage() {
    const container = document.getElementById('patient-types-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการประเภทผู้ป่วย</h2>
            <div class="space-y-2">
                <div class="p-3 bg-gray-50 rounded">นอก (OPD)</div>
                <div class="p-3 bg-gray-50 rounded">ใน (IPD)</div>
            </div>
        </div>
    `;
}

function renderPlacesPage() {
    const container = document.getElementById('places-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการสถานที่</h2>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อสถานที่</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(masterData.places || []).map(place => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${place.Name || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderProcessesPage() {
    const container = document.getElementById('processes-page');
    if (!container) return;
    // แสดง dropdown ตัวเลือกกระบวนการ
    const processOptions = (masterData.processes || []).map(p => p['กระบวนการ'] || p.Name || p.name || '').filter(Boolean);
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการกระบวนการ</h2>
            <div class="mb-4">
                <label for="process-dropdown" class="block text-sm font-medium text-gray-700 mb-2">ตัวเลือกกระบวนการ</label>
                <select id="process-dropdown" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">เลือก...</option>
                    ${processOptions.map(name => `<option value="${name}">${name}</option>`).join('')}
                </select>
            </div>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อกระบวนการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processOptions.length > 0 ? processOptions.map(name => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${name}</td>
                            </tr>
                        `).join('') : `<tr><td class="px-6 py-4 text-center text-gray-500">ไม่มีข้อมูลกระบวนการ</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderCausesPage() {
    const container = document.getElementById('causes-page');
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">จัดการสาเหตุ</h2>
            <div class="mt-4 overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">ชื่อสาเหตุ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(masterData.causes || []).map(cause => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-6 py-4 whitespace-nowrap">${cause.Name || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderRecordsList() {
    const container = document.getElementById('records-list-page');
    if (!container) return;
    if (!masterData.records || masterData.records.length === 0) {
        container.innerHTML = '<div class="p-6 bg-white rounded-lg shadow-md">ไม่มีข้อมูลรายการล่าสุด</div>';
        return;
    }
    // ฟังก์ชันแปลงวันที่เป็น yyyy-mm-dd
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    // กำหนดจำนวนรายการที่แสดง
    const perPageOptions = [10, 30, 50, 100];
    // สร้างเลขที่รายงาน (ลำดับล่าสุด = 1)
    const sortedRecords = [...masterData.records].sort((a, b) => new Date(b['วันที่เกิดเหตุการณ์']) - new Date(a['วันที่เกิดเหตุการณ์']));
    sortedRecords.forEach((r, idx) => r.__reportNo = idx + 1);
    // จำนวนที่จะแสดง
    const showCount = currentRecordsPerPage;
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">รายการล่าสุด</h2>
            <div class="mb-4 flex items-center gap-2">
                <label for="records-per-page" class="text-sm">แสดง</label>
                <select id="records-per-page" class="border border-gray-300 rounded px-2 py-1">
                    ${perPageOptions.map(opt => `<option value="${opt}" ${opt === showCount ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
                <span class="text-sm">รายการ</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">เลขที่รายงาน</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">วันที่เกิดเหตุการณ์</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">เวร</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">สถานที่</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">กระบวนการ</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">ข้อผิดพลาด</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">รายการยาที่ผิด</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">สาเหตุ</th>
                            <th class="px-4 py-2 text-xs font-medium text-gray-500 uppercase">ผู้บันทึก</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedRecords.slice(0, showCount).map(r => `
                            <tr class="hover:bg-gray-100">
                                <td class="px-4 py-2 whitespace-nowrap">${r.__reportNo}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${formatDate(r['วันที่เกิดเหตุการณ์'])}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['เวร'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['สถานที่'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['กระบวนการ'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['ข้อผิดพลาด'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['รายการยาที่ผิด'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['สาเหตุ'] || ''}</td>
                                <td class="px-4 py-2 whitespace-nowrap">${r['ผู้บันทึก'] || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    // เพิ่ม event เปลี่ยนจำนวนรายการ
    const perPageSelect = document.getElementById('records-per-page');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', (e) => {
            currentRecordsPerPage = parseInt(e.target.value, 10) || 10;
            renderRecordsList();
        });
    }
}

function renderDashboard() {
    const container = document.getElementById('dashboard-page');
    if (!container) return;

    // Check if records data is available
    if (!masterData.records || masterData.records.length === 0) {
        container.innerHTML = '<div class="p-6 bg-white rounded-lg shadow-md">ไม่พบข้อมูลสำหรับการแสดงแดชบอร์ด</div>';
        return;
    }

    // Get date range for filtering
    const now = new Date();
    const lastMonth = new Date(now);
    lastMonth.setMonth(now.getMonth() - 1);
    
    // Filter records from the last 30 days
    const recentRecords = masterData.records.filter(record => {
        const recordDate = new Date(record['วันที่เกิดเหตุการณ์']);
        return recordDate >= lastMonth && recordDate <= now;
    });

    // Calculate statistics
    const totalRecords = masterData.records.length;
    const recentRecordsCount = recentRecords.length;

    // Count errors by type
    const errorsByType = {};
    masterData.records.forEach(record => {
        const errorType = record['ข้อผิดพลาด'] || 'ไม่ระบุ';
        errorsByType[errorType] = (errorsByType[errorType] || 0) + 1;
    });

    // Count errors by process
    const errorsByProcess = {};
    masterData.records.forEach(record => {
        const process = record['กระบวนการ'] || 'ไม่ระบุ';
        errorsByProcess[process] = (errorsByProcess[process] || 0) + 1;
    });

    // Count errors by medicine
    const errorsByMedicine = {};
    masterData.records.forEach(record => {
        const medicine = record['รายการยาที่ผิด'] || 'ไม่ระบุ';
        errorsByMedicine[medicine] = (errorsByMedicine[medicine] || 0) + 1;
    });

    // Count errors by shift
    const errorsByShift = {};
    masterData.records.forEach(record => {
        const shift = record['เวร'] || 'ไม่ระบุ';
        errorsByShift[shift] = (errorsByShift[shift] || 0) + 1;
    });

    // Get top 5 error types
    const topErrorTypes = Object.entries(errorsByType)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // Get top 5 medicines with errors
    const topMedicinesWithErrors = Object.entries(errorsByMedicine)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // Render the dashboard HTML
    container.innerHTML = `
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="mb-6 text-xl font-bold text-gray-800">แดชบอร์ดข้อมูลความคลาดเคลื่อนทางยา</h2>
            
            <!-- Summary Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded-lg shadow border border-blue-200">
                    <h3 class="font-bold text-blue-800">จำนวนรายการทั้งหมด</h3>
                    <p class="text-2xl font-bold">${totalRecords}</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow border border-green-200">
                    <h3 class="font-bold text-green-800">รายการในช่วง 30 วันที่ผ่านมา</h3>
                    <p class="text-2xl font-bold">${recentRecordsCount}</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg shadow border border-yellow-200">
                    <h3 class="font-bold text-yellow-800">จำนวนประเภทข้อผิดพลาด</h3>
                    <p class="text-2xl font-bold">${Object.keys(errorsByType).length}</p>
                </div>
            </div>
            
            <!-- Top Error Types -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="p-4 bg-white rounded-lg shadow border">
                    <h3 class="font-bold mb-3">ข้อผิดพลาดที่พบบ่อย</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="errorTypesChart"></canvas>
                    </div>
                </div>
                
                <!-- Error by Shift -->
                <div class="p-4 bg-white rounded-lg shadow border">
                    <h3 class="font-bold mb-3">ข้อผิดพลาดตามช่วงเวร</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="errorsByShiftChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Errors by Process -->
                <div class="p-4 bg-white rounded-lg shadow border">
                    <h3 class="font-bold mb-3">ข้อผิดพลาดตามกระบวนการ</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="errorsByProcessChart"></canvas>
                    </div>
                </div>
                
                <!-- Top Medicines with Errors -->
                <div class="p-4 bg-white rounded-lg shadow border">
                    <h3 class="font-bold mb-3">รายการยาที่พบข้อผิดพลาดบ่อย</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="medicineErrorsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Table View of Recent Errors -->
            <div class="mt-6 p-4 bg-white rounded-lg shadow border">
                <h3 class="font-bold mb-3">รายการข้อผิดพลาดล่าสุด</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวร</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กระบวนการ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ข้อผิดพลาด</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายการยา</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${masterData.records.slice(0, 10).map(record => `
                                <tr>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${record['วันที่เกิดเหตุการณ์'] || '-'}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${record['เวร'] || '-'}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${record['กระบวนการ'] || '-'}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${record['ข้อผิดพลาด'] || '-'}</td>
                                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${record['รายการยาที่ผิด'] || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Load Chart.js from CDN if not already loaded
    if (!window.Chart) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = renderCharts;
        document.head.appendChild(script);
    } else {
        renderCharts();
    }

    function renderCharts() {
        // Function to generate random colors for charts
        const getRandomColor = () => {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        };

        // Generate colors array
        const generateColors = (count) => {
            // Predefined colors for visual consistency
            const predefinedColors = [
                'rgba(54, 162, 235, 0.7)', // Blue
                'rgba(255, 99, 132, 0.7)',  // Red
                'rgba(255, 206, 86, 0.7)',  // Yellow
                'rgba(75, 192, 192, 0.7)',  // Green
                'rgba(153, 102, 255, 0.7)', // Purple
                'rgba(255, 159, 64, 0.7)',  // Orange
                'rgba(199, 199, 199, 0.7)', // Gray
            ];
            
            // Return predefined colors or generate random ones if needed
            return Array.from({length: count}, (_, i) => 
                i < predefinedColors.length ? predefinedColors[i] : getRandomColor());
        };

        // Render Error Types Chart
        const errorTypesCtx = document.getElementById('errorTypesChart').getContext('2d');
        const errorTypeLabels = topErrorTypes.map(item => item[0]);
        const errorTypeData = topErrorTypes.map(item => item[1]);
        new Chart(errorTypesCtx, {
            type: 'bar',
            data: {
                labels: errorTypeLabels,
                datasets: [{
                    label: 'จำนวนครั้ง',
                    data: errorTypeData,
                    backgroundColor: generateColors(errorTypeLabels.length),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Render Errors by Shift Chart
        const errorsByShiftCtx = document.getElementById('errorsByShiftChart').getContext('2d');
        const shiftLabels = Object.keys(errorsByShift);
        const shiftData = Object.values(errorsByShift);
        new Chart(errorsByShiftCtx, {
            type: 'pie',
            data: {
                labels: shiftLabels,
                datasets: [{
                    data: shiftData,
                    backgroundColor: generateColors(shiftLabels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Render Errors by Process Chart
        const errorsByProcessCtx = document.getElementById('errorsByProcessChart').getContext('2d');
        const processLabels = Object.keys(errorsByProcess);
        const processData = Object.values(errorsByProcess);
        new Chart(errorsByProcessCtx, {
            type: 'bar',
            data: {
                labels: processLabels,
                datasets: [{
                    label: 'จำนวนครั้ง',
                    data: processData,
                    backgroundColor: generateColors(processLabels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Render Medicines Errors Chart
        const medicineErrorsCtx = document.getElementById('medicineErrorsChart').getContext('2d');
        const medicineLabels = topMedicinesWithErrors.map(item => item[0]);
        const medicineData = topMedicinesWithErrors.map(item => item[1]);
        new Chart(medicineErrorsCtx, {
            type: 'doughnut',
            data: {
                labels: medicineLabels,
                datasets: [{
                    data: medicineData,
                    backgroundColor: generateColors(medicineLabels.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
}
</script>
</body>
</html>
